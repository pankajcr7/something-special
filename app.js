// ===== DATABASE =====
const DB={pickup:{smooth:{mild:["Do you have a map? Because I just got lost in your eyes.","I must be a snowflake, because I've fallen for you.","Are you a parking ticket? Because you've got 'fine' written all over you.","Is your name Google? Because you have everything I've been searching for.","I'd say God bless you, but it looks like he already did.","If you were a vegetable, you'd be a cute-cumber.","Excuse me, but I think you dropped something: my jaw.","Do you believe in love at first sight, or should I walk by again?","Are you a campfire? Because you're hot and I want s'more.","I'm not a photographer, but I can picture us together."],bold:["If beauty were time, you'd be an eternity.","I'm not a genie, but I can make your dreams come true.","You must be tired because you've been running through my mind all day.","Is it hot in here or is it just you?","I'd never play hide and seek with you ‚Äî someone like you is impossible to find.","Your hand looks heavy. Let me hold it for you.","They say nothing lasts forever ‚Äî want to be my nothing?","I was going to say something really sweet about you, but when I saw you, I became speechless.","You must be a ninja, because you snuck into my heart.","You're like Wi-Fi ‚Äî I'm feeling a connection."],extreme:["I think God was showing off when He made you.","If kisses were snowflakes, I'd send you a blizzard.","Are you made of copper and tellurium? Because you're Cu-Te.","I'd rearrange the alphabet to put U and I together.","I must be a light switch, because you turn me on.","Do you have a sunburn, or are you always this hot?","I'm no organ donor, but I'd give you my heart.","Are you a time traveler? Because I see you in my future.","Somebody better call God, because he's missing an angel.","You don't need keys to drive me crazy."]},funny:{mild:["Are you a banana? Because I find you a-peeling!","I'm not a mathematician, but I think we're a perfect equation.","Do you have a name, or can I call you mine?","Are you from Tennessee? Because you're the only ten I see!","Do you like raisins? How about a date?","If you were a chicken, you'd be impeccable.","I must be a broom because I just swept you off my feet.","You must be made of cheese because you're looking gouda tonight.","Are you a keyboard? Because you're just my type.","Do you have a Band-Aid? Because I just scraped my knee falling for you."],bold:["Are you an alien? Because you just abducted my heart.","My love for you is like diarrhea ‚Äî I can't hold it in.","Are you a magician? Every time I look at you, everyone else disappears.","If you were a booger, I'd pick you first.","I'm not drunk, I'm just intoxicated by you.","Feel my shirt ‚Äî know what it's made of? Boyfriend material.","I'm on top of things. Would you like to be one of them?","Did you sit in sugar? Because you've got a pretty sweet butt.","You must be a campfire, because you're making me hot and I want s'more.","Is your dad a boxer? Because you're a total knockout!"],extreme:["If I could rearrange the alphabet, I'd put U and I in a bed together.","My name might not be Luna, but I sure can make your night magical.","Are you an exam? Because I've been studying you all night.","I'm not a weatherman, but you can expect a few inches tonight.","The word of the day is 'legs' ‚Äî let's go to my place and spread the word.","Are you my appendix? Because I have this funny feeling in my stomach that makes me want to take you out.","You're so hot, you denature my proteins.","Is your name Chapstick? Because you're da balm!","I'd like to take you to the movies, but they don't let you bring your own snacks.","You're so sweet you're giving me a toothache."]},romantic:{mild:["I didn't believe in love at first sight until I saw you.","Your smile is like sunshine on a rainy day.","In a room full of art, I'd still stare at you.","I think the sun is jealous of the way you shine.","I wonder if you know how beautiful you look right now.","Every love story is special, but ours would be my favorite.","You make me want to be a better person.","Your eyes are like stars ‚Äî I could stare at them all night.","Meeting you feels like a breath of fresh air.","You're the kind of beautiful that doesn't need makeup."],bold:["If I had a flower for every time you made me smile, I'd have a garden.","I've been thinking about you more than I should, but less than you deserve.","My heart skips a beat every time I see your name pop up.","You don't just cross my mind ‚Äî you live in it.","They say don't mix business with pleasure, but you're all pleasure.","I want to be the reason you look at your phone and smile.","If beauty were a crime, you'd be serving a life sentence.","I didn't plan on falling for anyone today, but you changed my mind.","Your voice is my favorite sound, and your name is my favorite word.","I could talk to you for hours and it would still feel like minutes."],extreme:["I want to wake up next to you every morning for the rest of my life.","You're not just my dream girl ‚Äî you're my everything.","I'd cross oceans for you. I'd move mountains for you. I'd do anything for you.","My heart wasn't complete until I found you.","You're the first thing I think about when I wake up and the last thing on my mind before I sleep.","If I could have anyone in the world, I'd still choose you.","I don't need paradise because I found you. I don't need dreams because I already have you.","You're the poem I never knew how to write.","I fell in love the way you fall asleep ‚Äî slowly, and then all at once.","Every moment with you feels like a beautiful dream I never want to wake up from."]},bold:{mild:["I'm not usually this forward, but you're worth the risk.","You caught my eye, and I had to come say hi.","I don't know what it is about you, but I can't look away.","Something tells me you're worth getting to know.","I've got a feeling you and I could have some fun together."],bold:["You look like you could use some good company.","I'm not shy, and I think you're absolutely stunning.","I'd be lying if I said I wasn't attracted to you.","Let's skip the small talk ‚Äî want to go on an adventure?","I've been told I'm pretty charming. Want to find out?"],extreme:["I want you. No games, no filters. Just you.","I can't stop thinking about you and honestly I don't want to.","You make my heart race and I barely know you.","I've never wanted someone this bad before.","Everything about you drives me crazy ‚Äî in the best way."]},nerdy:{mild:["Are you a 45-degree angle? Because you're acute one!","You must be the square root of -1, because you can't be real.","Are you made of Fluorine, Iodine, and Neon? Because you're F-I-Ne.","You're hotter than the bottom of my laptop.","I think you're the CSS to my HTML."],bold:["Are you a black hole? Because you just pulled me in.","I think we have great chemistry ‚Äî shall we test it?","You must be a neurotransmitter because you make my heart race.","Like a quantum state, I can't stop observing you.","You've got 11 out of 10 bits in my attractiveness register."],extreme:["I'll be the semicolon to your code ‚Äî you can't function without me.","Are you garbage collection? Because you make my heart stop.","My love for you is like a while(true) loop ‚Äî it never ends.","You overload my operators and override my methods.","You're the bug in my code ‚Äî I just can't get you out of my head."]},poetic:{mild:["You are the poem I didn't know my heart was writing.","If grace had a face, I think it would look like yours.","Your presence is a gentle storm I never want to end.","You are the first light in a sky full of stars.","Your smile is a verse I want to read forever."],bold:["I want to write every love poem with your name between the lines.","You are the ache in my chest that I never want to cure.","My soul knew you before my eyes ever did.","You make the dark feel less heavy.","Every second away from you feels like a sentence."],extreme:["I would burn the world to ashes just to write your name in them.","You are my ruin and my salvation.","I don't need heaven ‚Äî I've already touched divinity in you.","My love for you is the kind that poets die writing about.","You are the most beautiful catastrophe I've ever known."]}},reply:{smooth:{mild:["I'd say I'm surprised, but honestly, I saw this coming.","If flirting were a sport, you'd be a gold medalist.","Careful ‚Äî you keep talking like that and I might fall.","I appreciate the effort, but you had me at hello.","I was going to play hard to get, but then you made me smile."],bold:["You think you're smooth? Watch and learn.","I don't blush easily, but you might be the exception.","I'm not easy to impress, but you're making a strong case.","I wasn't planning on catching feelings today, but here we are.","You're dangerously good at this."],extreme:["Stop making me smile ‚Äî people are starting to notice.","I'm trying to play it cool, but you're making it impossible.","Keep talking like that and I'll have to marry you.","I've been hit with a lot of lines, but yours actually got me.","You're either a genius or a fool ‚Äî either way, I'm intrigued."]},funny:{mild:["I'd roast you, but my mama taught me not to burn trash.","That was cute, I'll give you a 6/10.","Was that a pickup line or a cry for help?","You're trying so hard it's almost adorable.","I'd ghost you but even my WiFi has better connections."],bold:["Nice try ‚Äî you almost made me feel something.","I'd swipe right on that line, ngl.","Did Google help you with that or are you naturally this smooth?","I laughed, but don't let that go to your head.","If I had a dollar for every line like that, I'd be broke ‚Äî that was original."],extreme:["That was so bad it circled back to being good.","I just snorted. Thanks for ruining my image.","Bro really said that with his whole chest üíÄ","I'm not sure if I should be impressed or concerned.","That line was illegal in 12 countries."]},romantic:{mild:["You always know the right thing to say.","That made my heart skip a little, not gonna lie.","Why do you have to be so sweet?","I'm smiling like an idiot because of you.","You make it hard to keep my guard up."],bold:["I wasn't ready for that. My heart just did a thing.","How do you always manage to make me feel this way?","You're the best thing that's happened to my inbox.","I think about you way more than I should admit.","Reading your texts is the highlight of my day."],extreme:["I literally held my phone to my chest after reading that.","You have my heart in your hands ‚Äî be careful with it.","I never believed in soulmates until you came along.","I'd choose you in every lifetime.","You're the reason I believe in love."]},bold:{mild:["Interesting approach. I respect the confidence.","Bold move ‚Äî let's see if you can keep up.","I like someone who doesn't beat around the bush.","That took guts. I'm mildly impressed.","You came in hot ‚Äî I respect it."],bold:["You've got my attention. Now what are you going to do with it?","Challenge accepted. Your move.","I don't know who gave you this confidence, but thank them.","Keep that energy ‚Äî I'm here for it.","Oh, you're dangerous. I like it."],extreme:["You just shifted the whole vibe. I'm locked in.","Nobody talks to me like that and gets away with it.","I'm either going to love you or destroy you. Maybe both.","You've got no idea what you just started.","Game on. But I should warn you ‚Äî I don't lose."]}},bio:{smooth:{mild:["Part-time dreamer, full-time good vibes only.","Coffee in one hand, confidence in the other.","Looking for someone to share sunsets and playlists with.","Simple. Honest. Down to earth. Maybe a little too cute.","Just someone who smiles a lot and means it."],bold:["I'm the main character, and this is my casting call.","Not here to play games ‚Äî unless it's Mario Kart.","If you can make me laugh, you've already won.","Professional overthinker. Amateur heart-stealer.","5'10 in shoes. 6'2 in confidence."],extreme:["You swiped right. Congratulations, your taste is impeccable.","Warning: may cause feelings you weren't prepared for.","I'm the vibe your ex couldn't match.","I'm not everyone's cup of tea ‚Äî I'm more like tequila.","You're not going to find someone like me. Don't let me go."]},funny:{mild:["Just here because my mom told me I'm a catch.","Will trade pickup lines for pizza.","Looking for someone to blame when I can't pick a restaurant.","I'm 99% funny and 1% serious about finding love.","Swipe right if you can name 3 dinosaurs."],bold:["I put the 'hot' in 'hot mess.'","I can cook minute rice in 58 seconds.","My love language is memes.","I'm basically a snack. A whole buffet, actually.","Dating me is like a rollercoaster ‚Äî terrifying but fun."],extreme:["My FBI agent thinks I'm hilarious.","I've been single long enough to know it's everyone else's fault.","I'm the reason they invented the 'unmatch' button.","If we match, I promise to be weirder than you.","Swipe right and let's be awkward together."]}},opener:{smooth:{mild:["Hey! Your profile caught my eye ‚Äî what's the story behind your first photo?","I noticed we both like the same things ‚Äî what got you into it?","If your personality is half as great as your smile, I'm in trouble.","Okay, I need to know ‚Äî are you a morning person or a night owl?","I'm curious ‚Äî what's the best trip you've ever taken?"],bold:["I swiped right so fast I think I broke my phone.","I'll shoot my shot ‚Äî are you always this stunning?","I have a feeling we'd get along. Want to prove me right?","Let's skip the boring 'hey' stage. Tell me your hot take.","Something about you stood out ‚Äî and I had to say hi."],extreme:["I'm going to be bold ‚Äî I think we'd be amazing together.","Every time I type something, I delete it because nothing seems good enough.","I think this is the start of something really good.","I don't message first often ‚Äî you should feel special.","I'm not great at opening lines, but I'm great at showing up."]},funny:{mild:["On a scale of 1 to 10, you're a 9 ‚Äî and I'm the 1 you need.","I've been staring at your profile for 5 min trying to be clever. This is it.","Hey! Just wanted to say‚Ä¶ I forgot. You're distracting.","If you were a fruit, you'd be a fineapple.","Do you like science? Because we've got chemistry."],bold:["I was going to send a cheesy line, but you deserve something gouda.","Let's be honest ‚Äî we both swiped right. Now what?","My friend dared me to message you. Thank them later.","I'm not saying I'm Batman, but have you ever seen us in the same room?","I just flipped a coin. Both sides say you should reply."]}},compliment:{smooth:{mild:["You have the kind of smile that makes the whole room brighter.","There's something about you that's magnetic.","You carry yourself with such grace.","You have a really kind energy.","I love the way your eyes light up when you talk."],bold:["Whoever ends up with you is the luckiest person alive.","You're the kind of beautiful that takes breath away.","There's something effortlessly stunning about you.","I've never met anyone who radiates so much warmth.","You have this presence that makes people want to be near you."],extreme:["Honestly, you're the most beautiful person I've ever seen.","You redefine what it means to be attractive.","I could look at you forever and never get tired.","You're not just beautiful ‚Äî you're unforgettable.","God really spent extra time on you."]}},roast:{smooth:{mild:["You're like a software update ‚Äî whenever I see you, I think 'not now.'","You bring everyone so much joy... when you leave.","You're proof that even Google can't find everything.","If you were any more basic, you'd be a pH 14.","I'd explain it to you, but I left my crayons at home."],bold:["I'd give you a nasty look, but you've already got one.","You're not stupid; you just have bad luck thinking.","You're like a cloud ‚Äî everything brightens when you disappear.","I'd roast you but I don't want to burn the trash.","I've seen sharper minds in a bowl of soup."],extreme:["If laughter is the best medicine, your face must be curing the world.","You're living proof that evolution makes mistakes.","I'd insult you, but nature already did.","If your brain was dynamite, there wouldn't be enough to blow your hat off.","Your secrets are always safe with me. I never listen when you tell me."]}},goodnight:{smooth:{mild:["Goodnight! Sweet dreams and all that cute stuff üåô","Sleep tight ‚Äî don't let the bed bugs bite!","Nighty night! Dream something fun tonight üí§","Rest well ‚Äî you deserve it after being amazing today.","Sending you sleepy vibes and warm blanket energy üõèÔ∏è"],bold:["Can't sleep yet because someone won't leave my mind. It's you.","Goodnight. Try not to dream about me... actually, go ahead üòè","Last text of the night, and it's for you. Sleep well.","I'd say sweet dreams, but you're already the sweetest dream I know.","Close your eyes. Imagine me telling you this in person. Goodnight üíú"],extreme:["I wish I could kiss you goodnight right now.","Falling asleep thinking about you has become my favorite routine.","One day, 'goodnight' won't mean goodbye ‚Äî it'll mean 'see you in the morning.'","You're my last thought tonight, and honestly, every night.","You're the most beautiful part of my day. Goodnight."]}},goodmorning:{smooth:{mild:["Good morning! Hope your day is as awesome as you are ‚òÄÔ∏è","Rise and shine! The world is lucky to have you today.","Morning! Here's your daily reminder that you're amazing.","Good morning! Sending you good vibes and good coffee ‚òï","New day, new chances to be awesome. Let's go!"],bold:["Good morning, beautiful. You woke up on my mind again.","Just so you know ‚Äî you're the first person I thought about today.","Morning! You were running through my dreams all night.","You make mornings worth waking up for.","Good morning to the reason I check my phone first thing üòè"],extreme:["I want you to be my first 'good morning' and last 'goodnight' ‚Äî forever.","Waking up knowing you exist is the best feeling.","Good morning, my love. I hope your day is half as beautiful as you.","I dreamed of you last night. Waking up was even better.","Every sunrise reminds me of you ‚Äî beautiful, warm, impossible to look away from."]}}};


// ===== NEW TONE STYLES =====
const NEW_STYLES={
savage:{mild:["I'd agree with you, but then we'd both be wrong.","You're not stupid ‚Äî you just have bad luck when thinking.","I'd explain it, but I don't have the crayons.","You're the human version of a participation trophy.","Somewhere out there, a tree is working hard to produce oxygen for you. Apologize to it."],bold:["I'd give you a nasty look, but you've already got one.","You bring everyone so much joy ‚Äî when you leave the room.","You're the reason the gene pool needs a lifeguard.","If I wanted to listen to someone talk nonsense, I'd follow you on Twitter.","You're like a Monday ‚Äî nobody likes you."],extreme:["I'm not saying you're dumb, I'm just saying you've got bad luck when it comes to thinking.","You're the reason God created the middle finger.","I'd call you a tool, but that implies you're useful.","Your birth certificate is an apology letter from the hospital.","You're not the dumbest person in the world, but you better hope they don't die."]},
sweet:{mild:["Just wanted you to know someone's thinking of you right now.","You make the world better just by being in it.","I hope today is as wonderful as your smile.","You deserve all the good things coming your way.","The world is brighter because you're here."],bold:["I could listen to you talk forever and never get bored.","Being around you feels like home.","You're the kind of person everyone deserves but very few find.","I don't say this often, but you're really special to me.","My favorite thing about my day is any part with you in it."],extreme:["You're the reason I believe good things still exist.","I'd wait a thousand lifetimes if it meant finding you in each one.","You make me want to be better ‚Äî not for me, but for you.","If I could give you one thing, it would be the ability to see yourself through my eyes.","My heart feels full when I'm with you, and empty when I'm not."]},
spicy:{mild:["I can't stop staring at your lips when you talk.","Something about you makes me want to misbehave.","You give off 'trouble in the best way' energy.","I had a dream about you last night... I'll tell you about it sometime.","There's a tension between us and I'm not mad about it."],bold:["I can't focus when you're around because all I think about is getting closer.","You have no idea what goes through my mind when I see you.","I want to know what you look like at 2 AM.","You make me think things I probably shouldn't say out loud.","The way you look at me... it's doing things to me."],extreme:["I want to taste your lips and forget my own name.","You make me want to do things I'd only whisper.","I can't be in the same room as you without wanting to touch you.","Every inch of you is a sin I want to commit.","I need you closer ‚Äî like skin-to-skin closer."]},
toxic:{mild:["I'm not jealous, I just don't like other people having what's mine.","I know I'm a red flag, but I look good waving.","You deserve better... but I'm what you want.","I'm not possessive, I'm protective. There's a difference.","I promise I'm the best worst decision you'll ever make."],bold:["If you leave, I'll still be the one you compare everyone to.","Nobody will ever love you the way I do, and that's not a promise, it's a threat.","I'm not toxic, I'm just passionate... aggressively.","You'll miss me at 3 AM. You always do.","Block me, unblock me, we both know how this ends."],extreme:["I'd burn this whole thing down before I let someone else have you.","You're mine and I don't share. Not even a little.","Hate me all you want ‚Äî you'll still dream about me tonight.","I know I'm chaos but you chose me and there's no refund.","If I can't have you, I'll make sure you can't forget me."]},
drunk:{mild:["heyyy youre so prettyyyyy did you know that ü•∫","i just wanna say... ur actually amazing and i mean it","okay but like WHY are you so cute it's not fair","im not drunk ur just really pretty and i had to tell you","bro i literally think about you all the time lol dont judge me"],bold:["okayyyy so i wasnt gonna text you but then i did sooo","you know what? i like you. there. i said it. no take backs.","im like 3 drinks in and all i can think about is your smile","listen. LISTEN. you are literally the hottest person i know and its annoying","i deleted this text 4 times already but screw it ‚Äî i miss you"],extreme:["i just told all my friends about you and they said im down bad. they're right.","if you were here right now i would literally not let you go","im fully aware ill regret this tmrw but i want you so bad rn","okay so hypothetically if i showed up at ur door rn... then what","i cant stop thinking about kissing you and honestly i dont even wanna stop"]},
villain:{mild:["I'm not the hero of this story, but I'm the one you'll remember.","They warned you about people like me. You should've listened.","I don't play fair, I play to win.","I'm the plot twist your love life didn't see coming.","You think you know me? That's cute."],bold:["I didn't come to be liked. I came to be unforgettable.","Fall for me if you dare ‚Äî I don't promise a soft landing.","I'm the darkness that makes the light look boring.","Everyone has a type. Mine is 'worth the chaos.'","I'll ruin your standards for everyone else. You're welcome."],extreme:["I'm the villain your heart keeps choosing and your brain keeps rejecting.","Love me or fear me ‚Äî either way, you'll never forget me.","I will destroy every wall you've built and make you thank me for it.","I'm not safe. I'm not gentle. And you don't want me to be.","You came looking for love. You found obsession. Same thing."]},
desi:{mild:["Arre yaar tujhe dekh ke dil garden garden ho gaya üå∏","Tu chai hai ya coffee? Tere bina neend nhi aati yaar","Tujhe dekha toh ye jaana sanam... matlab seriously kya vibe hai teri","Teri smile dekh ke Sharma ji ka beta bhi sharma jaaye üòÇ","Sun na, tu itni cute hai ki main apni lines bhool gaya","Oye hoye, kya baat hai aaj toh full mast lag rhi hai tu","Yaar tujhe dekh ke toh dil ka signal full aa jata hai üì∂","Arre tujhse milke toh poora din set ho gaya mera"],bold:["Chal na golgappe khilata hun ‚Äî but number dena padega üòè","Tu meri Simran hai bas train pakadni baaki hai üöÇ","Jab se tujhe dekha mera phone ka wallpaper boring lagta hai","Tere bina life hai jaise biryani bina masale ke ‚Äî incomplete yaar","Sun na tujhe patane ke liye main poori mehnat kr sakta hun ngl","Yaar tu toh full aag hai üî• fire brigade ko bulana padega","Tere saath coffee pe chalna mera sapna hai tbh","Arre tu meri zindagi ki Wi-Fi hai ‚Äî tere bina sab disconnect"],extreme:["Tujhe patane ke liye Bollywood hero banna pade toh ready hun üí™","Agar tu haan bol de toh abhi ghar pe mithai bhejwa dun","Tu meri zindagi ka 4G hai ‚Äî tere bina sab buffer üò≠","Main tere liye Devdas ban jaunga bas tu Paro mat banna pls","Teri ek smile ke liye poore desh ka data khatam kr dun","Yaar tu itni mast hai ki mere dost bhi jealous hote hain mujhse","Tujhe dekh ke lagta hai bhagwan ne extra time liya tujhpe","Arre chal shaadi kr lete hain direct ‚Äî kyu time waste krna üíÄ"]},
flirtyaf:{mild:["Is it hot in here or is that just the chemistry between us?","I keep catching myself smiling at my phone because of you.","You make me nervous in the best possible way.","I should be sleeping but I can't stop thinking about your face.","Every time you text me, my heart does this stupid little flip."],bold:["I want you to know you're the reason I take forever to fall asleep.","I've replayed our last conversation in my head like 47 times.","If you were here right now, I definitely wouldn't be able to keep my hands to myself.","You turn me on intellectually... and every other way tbh.","I'm trying to play it cool but honestly you're making me crazy."],extreme:["I can't function properly when you're around and I don't even care.","I want you in every way a person can want another person.","The things I'd do to you... I can't say them here.","You make me lose all self-control and I've never liked anything more.","I want all of you ‚Äî the good, the bad, and everything between the sheets."]}
};
Object.keys(DB).forEach(cat=>{Object.keys(NEW_STYLES).forEach(sty=>{if(!DB[cat][sty])DB[cat][sty]=NEW_STYLES[sty];});});

const _g=['gsk_2oDA7','TXmZY4Nbr','S4DZFjWGdy','b3FYnKvfx3','Man4P79WIR','J2xGprXX'];
const GROQ_KEY=_g.join('');
const GEMINI_KEY='';
const providers=[
{name:'Groq',enabled:()=>!!GROQ_KEY,call:async(msgs)=>{const res=await fetch('https://api.groq.com/openai/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${GROQ_KEY}`},body:JSON.stringify({model:'llama-3.3-70b-versatile',messages:msgs,temperature:1.0,max_tokens:1024})});if(!res.ok)throw new Error(`Groq ${res.status}`);const d=await res.json();return d?.choices?.[0]?.message?.content||'';}},
{name:'Gemini',enabled:()=>!!GEMINI_KEY,call:async(msgs)=>{const last=msgs[msgs.length-1]?.content||'';const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:last}]}]})});if(!res.ok)throw new Error(`Gemini ${res.status}`);const d=await res.json();return d?.candidates?.[0]?.content?.parts?.[0]?.text||'';}}
];

let category='pickup',style='smooth',lang='hinglish',intensity='bold';
let favorites=JSON.parse(localStorage.getItem('rizzFavs')||'[]');
let historyArr=JSON.parse(localStorage.getItem('rizzHistory')||'[]');
let soundEnabled=JSON.parse(localStorage.getItem('rizzSound') ?? 'true');
let lightMode=JSON.parse(localStorage.getItem('rizzLight') ?? 'false');
let battleStats=JSON.parse(localStorage.getItem('rizzBattle')||'{"total":0}');
let challengeData=JSON.parse(localStorage.getItem('rizzChallenge')||'{}');

// ===== SOUND SYSTEM =====
let audioCtx;
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx;}
function playSound(type){
if(!soundEnabled)return;
try{const ctx=getAudioCtx();const osc=ctx.createOscillator();const gain=ctx.createGain();osc.connect(gain);gain.connect(ctx.destination);
if(type==='generate'){osc.type='sine';osc.frequency.setValueAtTime(600,ctx.currentTime);osc.frequency.exponentialRampToValueAtTime(1200,ctx.currentTime+.15);gain.gain.setValueAtTime(.1,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.3);osc.start();osc.stop(ctx.currentTime+.3);}
else if(type==='copy'){osc.type='sine';osc.frequency.setValueAtTime(1000,ctx.currentTime);osc.frequency.setValueAtTime(1400,ctx.currentTime+.08);gain.gain.setValueAtTime(.08,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.2);osc.start();osc.stop(ctx.currentTime+.2);}
else if(type==='fav'){osc.type='triangle';osc.frequency.setValueAtTime(800,ctx.currentTime);osc.frequency.exponentialRampToValueAtTime(1600,ctx.currentTime+.2);gain.gain.setValueAtTime(.08,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.3);osc.start();osc.stop(ctx.currentTime+.3);}
else if(type==='vote'){osc.type='square';osc.frequency.setValueAtTime(500,ctx.currentTime);osc.frequency.exponentialRampToValueAtTime(900,ctx.currentTime+.12);gain.gain.setValueAtTime(.05,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.2);osc.start();osc.stop(ctx.currentTime+.2);}
else{osc.type='sine';osc.frequency.setValueAtTime(800,ctx.currentTime);gain.gain.setValueAtTime(.05,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+.08);osc.start();osc.stop(ctx.currentTime+.08);}
if(navigator.vibrate&&type!=='click')navigator.vibrate(type==='generate'?[30,20,30]:20);
}catch(e){}}

// ===== THEME =====
function initTheme(){if(lightMode){document.body.classList.add('light');toggleThemeIcons(true);}updateSoundBtn();}
function toggleTheme(){lightMode=!lightMode;document.body.classList.toggle('light',lightMode);toggleThemeIcons(lightMode);localStorage.setItem('rizzLight',JSON.stringify(lightMode));playSound('click');}
function toggleThemeIcons(isLight){const d=document.querySelector('.theme-icon-dark');const l=document.querySelector('.theme-icon-light');if(d)d.style.display=isLight?'none':'block';if(l)l.style.display=isLight?'block':'none';}
function toggleSound(){soundEnabled=!soundEnabled;localStorage.setItem('rizzSound',JSON.stringify(soundEnabled));updateSoundBtn();if(soundEnabled)playSound('click');}
function updateSoundBtn(){const b=document.getElementById('soundToggle');if(b)b.classList.toggle('muted',!soundEnabled);}

// ===== PWA =====
let deferredPrompt=null;
if('serviceWorker' in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;const b=document.getElementById('pwaBanner');if(b&&!localStorage.getItem('rizzPwaDismissed'))b.style.display='block';});
function initPWA(){
document.getElementById('pwaInstallBtn')?.addEventListener('click',async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;document.getElementById('pwaBanner').style.display='none';});
document.getElementById('pwaCloseBtn')?.addEventListener('click',()=>{document.getElementById('pwaBanner').style.display='none';localStorage.setItem('rizzPwaDismissed','true');});
}

// ===== DROPDOWNS =====
function initDropdowns(){
document.querySelectorAll('.custom-select').forEach(sel=>{
const display=sel.querySelector('.select-display'),dropdown=sel.querySelector('.select-dropdown');
if(!display||!dropdown)return;
display.addEventListener('click',e=>{e.stopPropagation();document.querySelectorAll('.custom-select.open').forEach(s=>{if(s!==sel)s.classList.remove('open');});sel.classList.toggle('open');playSound('click');});
dropdown.querySelectorAll('.select-option').forEach(opt=>{opt.addEventListener('click',()=>{
dropdown.querySelectorAll('.select-option').forEach(o=>o.classList.remove('selected'));opt.classList.add('selected');
const icon=sel.querySelector('.select-icon');if(icon&&opt.dataset.icon)icon.textContent=opt.dataset.icon;
sel.querySelector('.select-text').textContent=opt.textContent.replace(/^[^\w]+/,'').trim();sel.classList.remove('open');
const v=opt.dataset.value;if(sel.id==='categorySelect')category=v;else if(sel.id==='styleSelect')style=v;else if(sel.id==='langSelect')lang=v;playSound('click');
});});});
document.addEventListener('click',()=>document.querySelectorAll('.custom-select.open').forEach(s=>s.classList.remove('open')));
}

function initIntensity(){document.querySelectorAll('.int-btn').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.int-btn').forEach(x=>x.classList.remove('active'));b.classList.add('active');intensity=b.dataset.int;playSound('click');});});}

// ===== GENERATE =====
async function generateRizz(){
const btn=document.getElementById('genBtn');
if(btn.classList.contains('loading'))return;
btn.classList.add('loading');
btn.querySelector('.btn-text').textContent = 'Cookin...';

const ctx=''; // Context removed from main gen for simplicity, or add back if needed
try{
let lines=[];
// Try DB first
const dbCat=DB[category];
if(dbCat){
    const dbStyle=dbCat[style]||dbCat.smooth;
    const dbInt=dbStyle?.[intensity]||dbStyle?.bold||Object.values(dbStyle)[0];
    if(dbInt?.length) lines=[...dbInt].sort(()=>Math.random()-.5).slice(0,5);
}

// Fallback/Augment with AI
try{
    const ai=await callAI({category,style,lang,intensity,context:ctx,count:5});
    if(ai?.length) lines=ai; // Prefer AI if available
}catch(e){}

displayResults(lines);
addToHistory(lines,category,style);
playSound('generate');
launchConfetti();
}catch(e){showToast('Failed. Try again!');}
btn.classList.remove('loading');
btn.querySelector('.btn-text').textContent = 'Generate Rizz';
}

function displayResults(lines){
const c=document.getElementById('resultsArea');
c.innerHTML='';
lines.forEach((line,i)=>{
    const isFav=favorites.includes(line);
    const d=document.createElement('div');
    d.className='result-card';
    d.style.animationDelay=`${i*.05}s`;
    d.innerHTML=`
        <div class="result-content">${escHtml(line)}</div>
        <div class="result-actions">
            <button class="action-btn copy-btn" onclick="copyLine(this,'${escAttr(line)}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
            </button>
            <button class="action-btn share-btn" onclick="openShareCard('${escAttr(line)}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
            </button>
        </div>
    `;
    c.appendChild(d);
});
trackStat('generations',lines.length);
}

// ===== COPY / FAV =====
function copyLine(btn,text){navigator.clipboard.writeText(text).then(()=>{btn.textContent='‚úÖ Copied!';setTimeout(()=>btn.textContent='üìã Copy',1500);showToast('Copied!');playSound('copy');});}
function toggleFav(btn,text){const i=favorites.indexOf(text);if(i>-1){favorites.splice(i,1);btn.classList.remove('fav-active');}else{favorites.push(text);btn.classList.add('fav-active');playSound('fav');}localStorage.setItem('rizzFavs',JSON.stringify(favorites));updateFavCount();}
function updateFavCount(){const e=document.getElementById('favCount');if(e)e.textContent=favorites.length;}

// ===== FAV DRAWER =====
function openFavDrawer(){document.getElementById('favDrawer').classList.add('open');renderFavList();}
function closeFavDrawer(){document.getElementById('favDrawer').classList.remove('open');}
function renderFavList(){
const l=document.getElementById('favList');
if(!favorites.length){l.innerHTML='<div class="fav-empty">No saved lines yet. Start generating!</div>';return;}
l.innerHTML=favorites.map((f,i)=>`<div class="fav-item"><p class="fav-item-text">${escHtml(f)}</p><div class="fav-item-actions"><button class="fav-item-btn" onclick="copyLine(this,'${escAttr(f)}')">üìã Copy</button><button class="fav-item-btn" onclick="openShareCard('${escAttr(f)}')">üì§ Share</button><button class="fav-item-btn remove" onclick="removeFav(${i})">üóëÔ∏è</button></div></div>`).join('');
}
function removeFav(i){favorites.splice(i,1);localStorage.setItem('rizzFavs',JSON.stringify(favorites));renderFavList();updateFavCount();}

// ===== HISTORY =====
function addToHistory(lines,cat,sty){historyArr.unshift({id:Date.now(),timestamp:new Date().toISOString(),category:cat,style:sty,lines:[...lines]});if(historyArr.length>100)historyArr=historyArr.slice(0,100);localStorage.setItem('rizzHistory',JSON.stringify(historyArr));trackStat('styleUsage',sty);}
function openHistoryDrawer(){document.getElementById('historyDrawer').classList.add('open');renderHistoryList();}
function closeHistoryDrawer(){document.getElementById('historyDrawer').classList.remove('open');}
function renderHistoryList(filter=''){
const l=document.getElementById('historyList');
const filtered=filter?historyArr.filter(h=>h.lines.some(x=>x.toLowerCase().includes(filter.toLowerCase()))):historyArr;
if(!filtered.length){l.innerHTML='<div class="history-empty">No history yet. Start generating!</div>';return;}
const grouped={};filtered.forEach(h=>{const d=new Date(h.timestamp);const key=isToday(d)?'Today':isYesterday(d)?'Yesterday':d.toLocaleDateString();if(!grouped[key])grouped[key]=[];grouped[key].push(h);});
l.innerHTML=Object.entries(grouped).map(([day,entries])=>`<div class="history-group"><div class="history-group-title">${day}</div>${entries.map(e=>`<div class="history-item" onclick="this.querySelector('.history-item-actions').style.display=this.querySelector('.history-item-actions').style.display==='flex'?'none':'flex'"><div class="history-item-meta"><span class="history-item-tag">${e.category} ‚Ä¢ ${e.style}</span><span class="history-item-time">${new Date(e.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div><p class="history-item-text">${escHtml(e.lines[0]||'')}</p><div class="history-item-actions" style="display:none">${e.lines.map(x=>`<button class="fav-item-btn" onclick="event.stopPropagation();copyLine(this,'${escAttr(x)}')" title="${escAttr(x)}">üìã</button>`).join('')}</div></div>`).join('')}</div>`).join('');
}
function isToday(d){const t=new Date();return d.getDate()===t.getDate()&&d.getMonth()===t.getMonth()&&d.getFullYear()===t.getFullYear();}
function isYesterday(d){const t=new Date();t.setDate(t.getDate()-1);return d.getDate()===t.getDate()&&d.getMonth()===t.getMonth()&&d.getFullYear()===t.getFullYear();}

// ===== SHARE CARD =====
function openShareCard(text){document.getElementById('shareModal').style.display='flex';generateShareImage(text);}
function closeShareModal(){document.getElementById('shareModal').style.display='none';}
function generateShareImage(text){
const canvas=document.getElementById('shareCanvas');const ctx=canvas.getContext('2d');canvas.width=1080;canvas.height=1080;
const grad=ctx.createLinearGradient(0,0,1080,1080);grad.addColorStop(0,'#7c3aed');grad.addColorStop(.5,'#a855f7');grad.addColorStop(1,'#ec4899');
ctx.fillStyle=grad;ctx.fillRect(0,0,1080,1080);
ctx.fillStyle='rgba(0,0,0,0.1)';for(let i=0;i<8;i++){ctx.beginPath();ctx.arc(Math.random()*1080,Math.random()*1080,Math.random()*200+50,0,Math.PI*2);ctx.fill();}
ctx.fillStyle='rgba(255,255,255,0.05)';ctx.fillRect(60,60,960,960);
ctx.fillStyle='#fff';ctx.font='bold 44px Inter,system-ui,sans-serif';ctx.textAlign='center';
const words=text.split(' ');let lines=[],line='';
words.forEach(w=>{const test=line?line+' '+w:w;if(ctx.measureText(test).width>800){lines.push(line);line=w;}else line=test;});if(line)lines.push(line);
const lh=60,startY=540-(lines.length*lh)/2;
lines.forEach((l,i)=>{ctx.fillStyle='rgba(0,0,0,0.2)';ctx.fillText(l,542,startY+i*lh+2);ctx.fillStyle='#fff';ctx.fillText(l,540,startY+i*lh);});
ctx.fillStyle='rgba(255,255,255,0.5)';ctx.font='600 26px Inter,sans-serif';ctx.fillText('‚ö° RizzGPT',540,980);
const preview=document.getElementById('sharePreview');preview.src=canvas.toDataURL('image/png');
document.getElementById('shareDownload').onclick=()=>{const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download='rizzgpt-card.png';a.click();playSound('copy');showToast('Card downloaded!');};
document.getElementById('shareNative').onclick=async()=>{try{canvas.toBlob(async blob=>{if(navigator.share)await navigator.share({files:[new File([blob],'rizzgpt-card.png',{type:'image/png'})],title:'RizzGPT',text});else{navigator.clipboard.writeText(text);showToast('Text copied!');}});playSound('copy');}catch(e){navigator.clipboard.writeText(text);showToast('Text copied!');}};
}

// ===== RIZZ SCORE =====
async function analyzeRizzScore(){
const input=document.getElementById('rizzScoreInput').value.trim();if(!input){showToast('Enter a message to analyze!');return;}
const btn=document.getElementById('analyzeRizzBtn');btn.classList.add('loading');
try{
const msgs=[{role:'system',content:'You are a Rizz Score Analyzer. Rate the message on rizz. Return ONLY valid JSON: {"score":75,"confidence":80,"creativity":70,"charm":75,"humor":60,"label":"Smooth Operator","verdict":"Brief analysis."} Score 0-100. Labels: 0-20="Needs CPR", 21-40="Rookie Rizzer", 41-60="Decent Game", 61-80="Smooth Operator", 81-95="Certified Rizz Lord", 96-100="Rizz God".'},{role:'user',content:`Rate this: "${input}"`}];
const text=await callAIRaw(msgs);const json=JSON.parse(text.match(/\{[\s\S]*\}/)?.[0]||'{}');displayRizzScore(json);playSound('generate');trackStat('rizzScore',json.score||50);
}catch(e){displayRizzScore({score:Math.floor(Math.random()*40)+40,confidence:Math.floor(Math.random()*30)+50,creativity:Math.floor(Math.random()*30)+40,charm:Math.floor(Math.random()*30)+45,humor:Math.floor(Math.random()*30)+35,label:'Decent Game',verdict:'Shows some personality but could use more originality.'});}
btn.classList.remove('loading');
}
function displayRizzScore(data){
const result=document.getElementById('rizzScoreResult');result.style.display='block';
const svg=result.querySelector('.score-gauge');
if(!svg.querySelector('defs')){const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');defs.innerHTML='<linearGradient id="gaugeGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#6366f1"/><stop offset="50%" stop-color="#a855f7"/><stop offset="100%" stop-color="#ec4899"/></linearGradient>';svg.prepend(defs);}
const fill=document.getElementById('gaugeFill');const circ=2*Math.PI*85;fill.style.strokeDasharray=circ;fill.style.strokeDashoffset=circ;
requestAnimationFrame(()=>{fill.style.strokeDashoffset=circ-(data.score/100)*circ;});
animateNum('scoreNumber',0,data.score,1200);document.getElementById('scoreLabel').textContent=data.label||'‚Äî';
document.getElementById('scoreBreakdown').innerHTML=['confidence','creativity','charm','humor'].map(k=>`<div class="breakdown-item"><div class="breakdown-label">${k}</div><div class="breakdown-bar"><div class="breakdown-bar-fill ${k}" style="width:0%"></div></div><div class="breakdown-value">${data[k]||0}/100</div></div>`).join('');
setTimeout(()=>{document.querySelectorAll('.breakdown-bar-fill').forEach(b=>{const k=b.className.split(' ').pop();b.style.width=(data[k]||0)+'%';});},100);
document.getElementById('scoreVerdict').innerHTML=`<p class="verdict-text">${data.verdict||''}</p>`;
}
function animateNum(id,from,to,dur){const el=document.getElementById(id);const s=performance.now();(function tick(now){const p=Math.min((now-s)/dur,1);el.textContent=Math.round(from+(to-from)*(1-Math.pow(1-p,3)));if(p<1)requestAnimationFrame(tick);})(s);}

// ===== VIBE CHECK =====
async function analyzeVibe(){
const input=document.getElementById('vibeInput').value.trim();if(!input){showToast('Enter a message to analyze!');return;}
const vctx=document.getElementById('vibeContext').value.trim();
const btn=document.getElementById('vibeCheckBtn');btn.classList.add('loading');
try{
const msgs=[{role:'system',content:'You are a Vibe Check Analyzer for dating. Return ONLY valid JSON: {"interest":7,"mood":"Playful","flirting":true,"energy":"High","analysis":"They seem interested.","flags":[{"type":"green","text":"Asks questions back"},{"type":"yellow","text":"Short replies"}],"suggestion":"Mirror their energy."}'},{role:'user',content:`Analyze this message I received${vctx?' (context: '+vctx+')':''}:\n"${input}"`}];
const text=await callAIRaw(msgs);const json=JSON.parse(text.match(/\{[\s\S]*\}/)?.[0]||'{}');displayVibeResult(json);playSound('generate');
}catch(e){displayVibeResult({interest:6,mood:'Curious',flirting:false,energy:'Medium',analysis:'Seems moderately interested.',flags:[{type:'green',text:'Responded'},{type:'yellow',text:'Brief reply'}],suggestion:'Ask an engaging question to get them invested.'});}
btn.classList.remove('loading');
}
function displayVibeResult(data){
const r=document.getElementById('vibeResult');r.style.display='block';
const interest=data.interest||5,cls=interest>=7?'high':interest>=4?'medium':'low';
document.getElementById('vibeMeters').innerHTML=`<div class="vibe-meter"><div class="vibe-meter-label">Interest</div><div class="vibe-meter-value ${cls}">${interest}/10</div><div class="vibe-meter-sub">${interest>=7?'Very Interested':interest>=4?'Moderate':'Low Interest'}</div></div><div class="vibe-meter"><div class="vibe-meter-label">Energy</div><div class="vibe-meter-value">${data.energy||'Medium'}</div><div class="vibe-meter-sub">${data.mood||'Neutral'} vibe</div></div><div class="vibe-meter"><div class="vibe-meter-label">Flirting?</div><div class="vibe-meter-value ${data.flirting?'high':'low'}">${data.flirting?'Yes üòè':'Nope'}</div><div class="vibe-meter-sub">${data.flirting?'Flirt signals detected':'Casual tone'}</div></div><div class="vibe-meter"><div class="vibe-meter-label">Mood</div><div class="vibe-meter-value">${data.mood||'Neutral'}</div><div class="vibe-meter-sub">Overall tone</div></div>`;
document.getElementById('vibeAnalysis').innerHTML=`<div class="vibe-analysis-title">Analysis</div><p class="vibe-analysis-text">${data.analysis||''}</p>`;
document.getElementById('vibeFlags').innerHTML=(data.flags||[]).map(f=>`<span class="vibe-flag ${f.type}">${f.type==='green'?'‚úÖ':f.type==='red'?'üö©':'‚ö†Ô∏è'} ${f.text}</span>`).join('');
document.getElementById('vibeSuggestion').innerHTML=`<div class="vibe-suggestion-title">üí° Suggested Move</div><p class="vibe-suggestion-text">${data.suggestion||''}</p>`;
}

// ===== RIZZ BATTLE =====
let battleLines={A:'',B:''},battleVoted=false;
async function newBattle(){
const btn=document.getElementById('newBattleBtn');btn.classList.add('loading');battleVoted=false;
document.querySelectorAll('.battle-vote-btn').forEach(b=>{b.classList.remove('voted');b.disabled=false;});
document.querySelectorAll('.battle-card').forEach(c=>c.classList.remove('winner','loser'));
const styles=['smooth','funny','romantic','bold','nerdy','poetic','savage','sweet','spicy','toxic','drunk','villain','desi','flirtyaf'];
const s1=styles[Math.floor(Math.random()*styles.length)];let s2=styles[Math.floor(Math.random()*styles.length)];while(s2===s1)s2=styles[Math.floor(Math.random()*styles.length)];
try{
const msgs=[{role:'system',content:`Generate 2 pickup lines. Line A: ${s1} style. Line B: ${s2} style. Return ONLY two lines, one per line. No numbers, labels, or quotes.`},{role:'user',content:'Generate 2 contrasting pickup lines.'}];
const text=await callAIRaw(msgs);const parsed=text.split('\n').map(l=>l.replace(/^\d+[.)\-:\s]*/,'').replace(/^["']/,'').replace(/["']$/,'').replace(/^Line\s*[AB]:?\s*/i,'').trim()).filter(l=>l.length>10);
battleLines.A=parsed[0]||getRandomDB(s1);battleLines.B=parsed[1]||getRandomDB(s2);
}catch(e){battleLines.A=getRandomDB(s1);battleLines.B=getRandomDB(s2);}
document.getElementById('battleTextA').textContent=battleLines.A;document.getElementById('battleTextB').textContent=battleLines.B;
document.querySelector('#battleLeft .battle-label').textContent=`üÖ∞Ô∏è ${cap(s1)}`;document.querySelector('#battleRight .battle-label').textContent=`üÖ±Ô∏è ${cap(s2)}`;
btn.classList.remove('loading');playSound('generate');
}
function voteBattle(side){
if(battleVoted)return;battleVoted=true;
battleStats.total=(battleStats.total||0)+1;localStorage.setItem('rizzBattle',JSON.stringify(battleStats));
document.getElementById('battleCount').textContent=`${battleStats.total} battles`;
document.getElementById('vote'+side).classList.add('voted');
document.getElementById(side==='A'?'battleLeft':'battleRight').classList.add('winner');
document.getElementById(side==='A'?'battleRight':'battleLeft').classList.add('loser');
document.querySelectorAll('.battle-vote-btn').forEach(b=>b.disabled=true);
playSound('vote');launchConfetti();
}
function getRandomDB(sty){const s=DB.pickup[sty]||DB.pickup.smooth;const p=s.bold||Object.values(s)[0]||[];return p[Math.floor(Math.random()*p.length)]||'Are you a magician?';}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}

// ===== DAILY CHALLENGE =====
const CHALLENGES=[
{prompt:"Rizz using only food references üçï",desc:"Every metaphor must involve food. The cheesier, the better."},
{prompt:"Movie-themed rizz only üé¨",desc:"Reference a famous movie or character."},
{prompt:"One-word opener challenge üí¨",desc:"A single powerful word that demands a response."},
{prompt:"Compliment without mentioning looks üß†",desc:"Make them feel special without referencing appearance."},
{prompt:"Rizz in exactly 5 words ‚úã",desc:"Maximum impact in exactly five words."},
{prompt:"Science-themed pickup lines üî¨",desc:"Use science concepts to create your line."},
{prompt:"Time traveler rizz ‚è∞",desc:"Pretend you're from the future."},
{prompt:"Reverse psychology rizz üîÑ",desc:"Use reverse psychology to be irresistible."},
{prompt:"Emoji-first then text üíå",desc:"Start with 3 mood-setting emojis, then the line."},
{prompt:"Roast-to-rizz pipeline üî•",desc:"Start with a light roast, end with a compliment."},
{prompt:"Song lyric remix üéµ",desc:"Remix a famous lyric into a pickup line."},
{prompt:"Animal-themed lines üêæ",desc:"Use animal references for cute or clever lines."},
{prompt:"Superhero rizz ü¶∏",desc:"Reference a superhero or superpower."},
{prompt:"Weather-themed flirting ‚õàÔ∏è",desc:"Use weather metaphors."},
{prompt:"Sports analogy rizz üèÄ",desc:"Score with a sports-themed line."},
{prompt:"Space & astronomy üåå",desc:"Out-of-this-world cosmic lines."},
{prompt:"History class rizz üìö",desc:"Reference historical events or figures."},
{prompt:"Math pickup lines üìê",desc:"Love is all about numbers."},
{prompt:"Social media themed üì±",desc:"Reference social media culture."},
{prompt:"Grammar nerd rizz ‚úèÔ∏è",desc:"Wordplay, puns, or grammar jokes."},
{prompt:"Coffee shop rizz ‚òï",desc:"Perfect line for a coffee shop setting."},
{prompt:"Late night text rizz üåô",desc:"The perfect 11 PM bold text."},
{prompt:"Bookworm rizz üìñ",desc:"Reference a famous book or character."},
{prompt:"Gym rizz üí™",desc:"Fitness-themed pickup line."},
{prompt:"Coding pickup lines üíª",desc:"Lines only a programmer would love."},
{prompt:"Art museum rizz üé®",desc:"Paint a picture with your words."},
{prompt:"Travel-themed rizz ‚úàÔ∏è",desc:"Take them on a journey."},
{prompt:"Zodiac sign rizz ‚ôà",desc:"Astrology-based charm."},
{prompt:"Cooking rizz üë®‚Äçüç≥",desc:"You're the chef of love."},
{prompt:"Adventure opener üèîÔ∏è",desc:"Invite someone on an adventure."},
{prompt:"Holiday special üéÑ",desc:"Theme around any holiday."}
];
function getDailyChallenge(){const d=new Date();return CHALLENGES[Math.floor((d-new Date(d.getFullYear(),0,0))/(864e5))%CHALLENGES.length];}
function initChallenge(){
const ch=getDailyChallenge(),today=new Date().toDateString();
document.getElementById('challengePrompt').textContent=ch.prompt;
document.getElementById('challengeDesc').textContent=ch.desc;
document.getElementById('challengeDate').textContent=new Date().toLocaleDateString([],{weekday:'long',month:'short',day:'numeric'});
document.getElementById('streakCount').textContent=calcStreak();
if(challengeData.completedDate===today){
document.getElementById('challengeGenBtn').textContent='‚úÖ Completed!';document.getElementById('challengeGenBtn').style.opacity='.6';
if(challengeData.results){const r=document.getElementById('challengeResults');r.style.display='block';r.innerHTML=challengeData.results.map(x=>`<div class="result-item"><p class="result-text">${escHtml(x)}</p><div class="result-actions"><button class="result-action-btn copy-btn" onclick="copyLine(this,'${escAttr(x)}')">üìã Copy</button><button class="result-action-btn share-btn" onclick="openShareCard('${escAttr(x)}')">üì§ Share</button></div></div>`).join('');}
}
}
function calcStreak(){if(!challengeData.lastCompleted)return 0;const diff=Math.floor((new Date()-new Date(challengeData.lastCompleted))/864e5);return diff>1?0:challengeData.streak||0;}
async function generateChallenge(){
    const today=new Date().toDateString();
    
    // Check if already completed (and UI wasn't updated for some reason)
    const btn=document.querySelector('.dc-btn');
    if(challengeData.completedDate===today){
        showToast('Challenge already completed today!');
        if(btn) { btn.textContent = 'Completed ‚úÖ'; btn.disabled=true; }
        return;
    }
    
    if(btn) { btn.classList.add('loading'); btn.textContent='Cooking...'; btn.disabled=true; }
    
    try{
        const ch=getDailyChallenge();
        let lines;
        try{
            const msgs=[{role:'system',content:'You are RizzGPT. Generate 3 creative lines for this challenge. Match the theme. Return 3 lines, one per line. No numbers. Write in Hinglish ‚Äî casual Hindi+English mix in Roman script like real young Indians text. Use yaar/arre/accha/chal naturally. NO pure English. NO formal Hindi. Example style: "arre yaar teri smile toh kamaal hai üî•"'},{role:'user',content:`Challenge: ${ch.prompt}\n${ch.desc}\nGenerate in Hinglish ‚Äî Hindi+English mix like real WhatsApp texting.`}];
            lines=parseAIResponse(await callAIRaw(msgs),3);
        }catch(e){
            lines=['Challenge accepted ‚Äî tera rizz loading ho rha hai yaar!','Charm level full charge ho rha hai üî•','Ek baar aur try kr, AI powered results aayenge!'];
        }
        
        // Update Data
        let streak=challengeData.streak||0;
        const prev=challengeData.lastCompleted?new Date(challengeData.lastCompleted):null;
        
        // Check if streak continues (completed yesterday)
        const ONE_DAY = 86400000;
        const diff = prev ? (new Date() - prev) : 0;
        if(prev && diff < (ONE_DAY * 2)) {
            streak++;
        } else {
            streak = 1;
        }
        
        challengeData = {
            completedDate: today,
            lastCompleted: new Date().toISOString(),
            streak: streak,
            results: lines
        };
        localStorage.setItem('rizzChallenge',JSON.stringify(challengeData));
        
        // Update UI
        displayChallengeResults(lines); // New function I added in index.html logic but need to ensure it's here if not
        
        if(btn) { btn.textContent='See Results Below üëá'; }
        
        // Update Streak Badges
        const sb = document.getElementById('streakBadgeHeader');
        if(sb) sb.textContent = `üî• ${streak}`;
        
        playSound('generate');
        launchConfetti();
        showToast(`Challenge Done! Streak: ${streak} üî•`);
        
    } catch(e) {
        showToast('Failed. Try again!');
        if(btn) { btn.classList.remove('loading'); btn.textContent='Generate Lines'; btn.disabled=false; }
    }
}

// ===== GEN TABS =====
function initTabs(){document.querySelectorAll('.gen-tab').forEach(tab=>{tab.addEventListener('click',()=>{document.querySelectorAll('.gen-tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');document.querySelectorAll('.gen-panel').forEach(p=>p.classList.remove('active'));const panel=document.getElementById('panel'+cap(tab.dataset.tab));if(panel)panel.classList.add('active');playSound('click');});});}

// ===== AI =====
async function callAI(opts){
const isHinglish=opts.lang==='hinglish';
const isHindi=opts.lang==='hindi';
const langInstructions=isHinglish?`Language: HINGLISH ‚Äî casual Hindi+English mix in Roman script like real young Indians text on WhatsApp.
HINGLISH RULES:
- Mix Hindi + English naturally. NOT pure English. NOT pure Hindi. NOT formal.
- Use fillers: yaar, arre, accha, chal, sun, bhai, na, re, oye, matlab, bas
- Use texting shortcuts: nhi, thk h, pta nhi, koi ni, kya, kyu, acha, chl, krna
- Sound like real WhatsApp texts: "arre yaar tu toh full cute hai", "chal na coffee pe chalte h", "teri smile dekh ke dimag kharab üò≠"
- NO Devanagari. NO formal aap/aapko ‚Äî use tu/tujhe/tere
- BAD: "Aapki aankhein bahut sundar hain" ‚Üí GOOD: "yaar teri eyes toh kamaal h üî•"
- BAD: "Main aapko pasand karta hoon" ‚Üí GOOD: "tu mujhe bohot acchi lagti hai ngl"`:isHindi?'Language: Casual Roman Hindi (NO Devanagari). Like real Indian WhatsApp texting. Use shortcuts: nhi, acha, thk h, chl. NO formal Hindi.':`Language: ${opts.lang}.`;
const sys=`You are RizzGPT. Generate ${opts.count||5} ${opts.style} ${opts.category} lines. Intensity: ${opts.intensity}. ${langInstructions}${opts.context?' Context: '+opts.context:''} Return ONLY lines, one per line. No numbering.`;
const messages=[{role:'system',content:sys},{role:'user',content:`Generate ${opts.count||5} ${opts.intensity} ${opts.style} ${opts.category} lines.${isHinglish?' Remember: Hinglish only ‚Äî Hindi+English mix in Roman script like real Indian texting. NO pure English.':''}`}];
let lastErr;for(const p of providers){if(!p.enabled())continue;try{const t=await Promise.race([p.call(messages),new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),15000))]);if(!t||t.trim().length<5)throw new Error('empty');return parseAIResponse(t,opts.count);}catch(e){lastErr=e;}}throw lastErr||new Error('All failed');
}
async function callAIRaw(messages){let lastErr;for(const p of providers){if(!p.enabled())continue;try{const t=await Promise.race([p.call(messages),new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),15000))]);if(!t||t.trim().length<5)throw new Error('empty');return t;}catch(e){lastErr=e;}}throw lastErr||new Error('All failed');}
function parseAIResponse(text,count){return text.split('\n').map(l=>l.replace(/^\d+[.)\-:\s]+/,'').replace(/^"/,'').replace(/"$/,'').trim()).filter(l=>l.length>5&&!l.startsWith('#')&&!l.startsWith('*')&&!l.toLowerCase().startsWith('here')&&!l.toLowerCase().startsWith('sure')).slice(0,count||5);}

// ===== CONFETTI =====
function launchConfetti(){const w=document.getElementById('confettiWrap');const colors=['#a855f7','#ec4899','#6366f1','#f59e0b','#22c55e'];for(let i=0;i<30;i++){const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'%';c.style.top='-10px';c.style.background=colors[Math.floor(Math.random()*colors.length)];c.style.animationDelay=Math.random()*.5+'s';c.style.width=(Math.random()*6+4)+'px';c.style.height=(Math.random()*6+4)+'px';w.appendChild(c);setTimeout(()=>c.remove(),2000);}}

// ===== TOAST =====
function showToast(msg){const t=document.getElementById('toast');document.getElementById('toastText').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}

// ===== UTILS =====
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escAttr(s){return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');}

// ===== MENU =====
function initMenu(){document.getElementById('menuBtn')?.addEventListener('click',()=>{document.getElementById('navLinks').classList.toggle('open');playSound('click');});}

// ===== INIT =====
document.addEventListener('DOMContentLoaded',()=>{
initTheme();initPWA();initMenu();initDropdowns();initIntensity();initTabs();initChallenge();updateFavCount();
document.getElementById('generateBtn')?.addEventListener('click',generateLines);
document.getElementById('favBtn')?.addEventListener('click',openFavDrawer);
document.getElementById('historyBtn')?.addEventListener('click',openHistoryDrawer);
document.getElementById('themeToggle')?.addEventListener('click',toggleTheme);
document.getElementById('soundToggle')?.addEventListener('click',toggleSound);
document.getElementById('analyzeRizzBtn')?.addEventListener('click',analyzeRizzScore);
document.getElementById('vibeCheckBtn')?.addEventListener('click',analyzeVibe);
document.getElementById('newBattleBtn')?.addEventListener('click',newBattle);
document.getElementById('voteA')?.addEventListener('click',()=>voteBattle('A'));
document.getElementById('voteB')?.addEventListener('click',()=>voteBattle('B'));
document.getElementById('challengeGenBtn')?.addEventListener('click',generateChallenge);
document.getElementById('clearHistoryBtn')?.addEventListener('click',()=>{historyArr=[];localStorage.setItem('rizzHistory','[]');renderHistoryList();showToast('History cleared!');});
document.getElementById('historySearch')?.addEventListener('input',e=>renderHistoryList(e.target.value));
document.getElementById('battleCount').textContent=`${battleStats.total||0} battles`;
newBattle();
initRoulette();
renderStatsDashboard();
updateStreak();
initMainScreenshot();
checkScheduledCompliments();
});

// ===== VOICE RIZZ (Web Speech API) =====
function speakText(text){
if(!('speechSynthesis' in window)){showToast('Speech not supported');return;}
window.speechSynthesis.cancel();
const u=new SpeechSynthesisUtterance(text);
u.rate=0.95;u.pitch=1.05;u.volume=1;
const voices=window.speechSynthesis.getVoices();
const pref=voices.find(v=>v.lang.startsWith('en')&&v.name.includes('Female'))||voices.find(v=>v.lang.startsWith('en'))||voices[0];
if(pref)u.voice=pref;
window.speechSynthesis.speak(u);
showToast('üîä Speaking...');
}

// ===== RIZZ ROULETTE =====
const ROULETTE_SEGMENTS=[
{label:'üíò Pickup',color:'#a855f7',cat:'pickup'},
{label:'üí¨ Reply',color:'#6366f1',cat:'reply'},
{label:'‚úçÔ∏è Bio',color:'#ec4899',cat:'bio'},
{label:'üëã Opener',color:'#f59e0b',cat:'opener'},
{label:'üíê Compliment',color:'#22c55e',cat:'compliment'},
{label:'üî• Roast',color:'#ef4444',cat:'roast'},
{label:'üåô Goodnight',color:'#3b82f6',cat:'goodnight'},
{label:'‚òÄÔ∏è Morning',color:'#f97316',cat:'goodmorning'}
];
let rouletteSpinning=false;
function initRoulette(){
const canvas=document.getElementById('rouletteWheel');
if(!canvas)return;
const ctx=canvas.getContext('2d');
const segs=ROULETTE_SEGMENTS;
const arc=2*Math.PI/segs.length;
const cx=150,cy=150,r=140;
segs.forEach((s,i)=>{
const a0=i*arc-Math.PI/2,a1=a0+arc;
ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,a0,a1);ctx.closePath();
ctx.fillStyle=s.color;ctx.fill();
ctx.strokeStyle='rgba(0,0,0,0.3)';ctx.lineWidth=2;ctx.stroke();
const mid=a0+arc/2;
ctx.save();ctx.translate(cx+Math.cos(mid)*(r*0.65),cy+Math.sin(mid)*(r*0.65));
ctx.rotate(mid+Math.PI/2);ctx.fillStyle='#fff';ctx.font='bold 11px Inter,sans-serif';
ctx.textAlign='center';ctx.fillText(s.label,0,0);ctx.restore();
});
ctx.beginPath();ctx.moveTo(cx,cy-r-10);ctx.lineTo(cx-8,cy-r+8);ctx.lineTo(cx+8,cy-r+8);ctx.closePath();
ctx.fillStyle='#fff';ctx.fill();
document.getElementById('spinBtn')?.addEventListener('click',spinRoulette);
}
function spinRoulette(){
if(rouletteSpinning)return;
rouletteSpinning=true;
const btn=document.getElementById('spinBtn');
btn.disabled=true;
const canvas=document.getElementById('rouletteWheel');
const totalDeg=1800+Math.random()*1800;
canvas.style.transition='transform 4s cubic-bezier(0.17,0.67,0.12,0.99)';
canvas.style.transform=`rotate(${totalDeg}deg)`;
playSound('generate');
setTimeout(()=>{
const finalDeg=totalDeg%360;
const segIdx=Math.floor(((360-finalDeg+90)%360)/(360/ROULETTE_SEGMENTS.length))%ROULETTE_SEGMENTS.length;
const seg=ROULETTE_SEGMENTS[segIdx];
const styles=['smooth','funny','romantic','bold','savage','sweet','spicy','nerdy','poetic','flirtyaf'];
const rndStyle=styles[Math.floor(Math.random()*styles.length)];
const db=DB[seg.cat];
let line='Spin again for a fresh line!';
if(db){
const s=db[rndStyle]||db.smooth||Object.values(db)[0];
const pool=s?.bold||s?.mild||Object.values(s)[0]||[];
if(pool.length)line=pool[Math.floor(Math.random()*pool.length)];
}
const res=document.getElementById('rouletteResult');
res.style.display='block';
document.getElementById('rouletteResCat').textContent=`${seg.label} ‚Ä¢ ${cap(rndStyle)}`;
document.getElementById('rouletteResText').textContent=line;
launchConfetti();
rouletteSpinning=false;btn.disabled=false;
trackStat('rouletteSpins');
},4200);
}

// ===== STATS TRACKING =====
function getStats(){return JSON.parse(localStorage.getItem('rizzStats')||'{"generations":0,"rouletteSpins":0,"toolUses":0,"scores":[],"styleUsage":{}}');}
function saveStats(s){localStorage.setItem('rizzStats',JSON.stringify(s));}
function trackStat(key,val){
const s=getStats();
if(key==='generations')s.generations=(s.generations||0)+(val||1);
else if(key==='rouletteSpins')s.rouletteSpins=(s.rouletteSpins||0)+1;
else if(key==='toolUses')s.toolUses=(s.toolUses||0)+1;
else if(key==='rizzScore'){if(!s.scores)s.scores=[];s.scores.push(val);if(s.scores.length>50)s.scores=s.scores.slice(-50);}
else if(key==='styleUsage'){if(!s.styleUsage)s.styleUsage={};s.styleUsage[val]=(s.styleUsage[val]||0)+1;}
saveStats(s);
}
function updateStreak(){
const s=getStats();
const today=new Date().toDateString();
if(!s.lastVisit){s.lastVisit=today;s.streak=1;}
else if(s.lastVisit!==today){
const last=new Date(s.lastVisit);
const diff=Math.floor((new Date()-last)/(86400000));
s.streak=diff<=1?(s.streak||0)+1:1;
s.lastVisit=today;
}
saveStats(s);
}
function renderStatsDashboard(){
    const s=getStats();
    
    // Update Profile View Stats
    const elGen = document.getElementById('statGenerations');
    const elStreak = document.getElementById('statStreak');
    const elToday = document.getElementById('statToday');
    
    if(elGen) elGen.textContent = s.generations || 0;
    if(elStreak) elStreak.textContent = s.streak || 0;
    
    // Calculate Today's Count (simple implementation)
    // In a real app we'd track this in state properly
    const todayKey = new Date().toDateString();
    const storedToday = localStorage.getItem('rizzTodayCountDate');
    let todayCount = parseInt(localStorage.getItem('rizzTodayCount') || '0');
    
    if(storedToday !== todayKey) {
        todayCount = 0;
        localStorage.setItem('rizzTodayCountDate', todayKey);
        localStorage.setItem('rizzTodayCount', '0');
    }
    
    if(elToday) elToday.textContent = todayCount;
    
    // Update Header Badge
    const elHeaderBadge = document.getElementById('streakBadgeHeader');
    if(elHeaderBadge) elHeaderBadge.textContent = `üî• ${s.streak || 0}`;
}

// Hook into trackStat to update "Today"
const _origTrackStat = trackStat;
trackStat = function(key, val) {
    _origTrackStat(key, val);
    if(key === 'generations') {
        const todayKey = new Date().toDateString();
        const storedToday = localStorage.getItem('rizzTodayCountDate');
        let todayCount = parseInt(localStorage.getItem('rizzTodayCount') || '0');
        
        if(storedToday !== todayKey) {
            todayCount = 0;
            localStorage.setItem('rizzTodayCountDate', todayKey);
        }
        
        todayCount += (val || 1); // val is usually count, default 1
        localStorage.setItem('rizzTodayCount', todayCount.toString());
        renderStatsDashboard();
    }
};

// ===== TOOL MODAL =====
function openTool(name){
const overlay=document.getElementById('toolOverlay');
const title=document.getElementById('toolModalTitle');
const body=document.getElementById('toolModalBody');
trackStat('toolUses');
playSound('click');

switch(name){
case 'profileRoast':
title.textContent='üî• Profile Roast & Review';
body.innerHTML=`<label class="tool-label">Paste your dating profile bio</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., Just a chill guy who loves pizza and Netflix..." rows="4"></textarea><label class="tool-label" style="margin-top:10px">What vibe are you going for? (optional)</label><div class="tool-chips" id="bioVibeChips">${['Funny','Smooth','Bold','Mysterious','Nerdy','Romantic'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-vibe="${v}">${v}</span>`).join('')}</div><div style="display:flex;gap:8px;margin-top:10px"><button class="tool-gen-btn" id="toolGenBtn" style="flex:1">üî• Roast My Profile</button><button class="tool-gen-btn" id="toolSuggestBtn" style="flex:1;background:linear-gradient(135deg,#6366f1,#a855f7)">‚ú® Suggest 5 Bios</button></div><div id="toolResult"></div>`;
document.querySelectorAll('#bioVibeChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#bioVibeChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runProfileRoast;
document.getElementById('toolSuggestBtn').onclick=runBioSuggest;
break;
case 'responsePred':
title.textContent='üîÆ Response Predictor';
body.innerHTML=`<label class="tool-label">What did you send?</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., hey, you looked really cute today" rows="3"></textarea><label class="tool-label">Their personality (optional)</label><input class="tool-input" id="toolInput2" placeholder="e.g., shy, sarcastic, flirty"><button class="tool-gen-btn" id="toolGenBtn">üîÆ Predict Response</button><div id="toolResult"></div>`;
document.getElementById('toolGenBtn').onclick=runResponsePredictor;
break;
case 'remixer':
title.textContent='üéµ Pickup Line Remixer';
body.innerHTML=`<label class="tool-label">Original line</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., Are you a magician? Because whenever I look at you, everyone else disappears." rows="3"></textarea><label class="tool-label">Remix styles</label><div class="tool-chips" id="remixChips">${['smooth','funny','romantic','bold','savage','sweet','spicy','nerdy','poetic','toxic','villain','desi','flirtyaf'].map((s,i)=>`<span class="tool-chip${i<3?' active':''}" data-style="${s}">${cap(s)}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">üéµ Remix It</button><div id="toolResult"></div>`;
document.querySelectorAll('#remixChips .tool-chip').forEach(c=>c.onclick=()=>c.classList.toggle('active'));
document.getElementById('toolGenBtn').onclick=runRemixer;
break;
case 'situational':
title.textContent='üìç Situational Rizz';
body.innerHTML=`<label class="tool-label">Pick a situation</label><div class="tool-situation-grid" id="sitGrid">${[
{e:'‚òï',n:'Coffee Shop'},{e:'üí™',n:'Gym'},{e:'üìö',n:'Library'},{e:'üéâ',n:'Party'},
{e:'üì±',n:'DMs/Online'},{e:'üè¢',n:'Office'},{e:'üèñÔ∏è',n:'Beach'},{e:'üéµ',n:'Concert'},
{e:'üõí',n:'Grocery Store'},{e:'üêï',n:'Dog Park'},{e:'‚úàÔ∏è',n:'Airport'},{e:'üç∑',n:'Bar/Club'}
].map(s=>`<div class="tool-sit-card" data-sit="${s.n}"><span class="sit-emoji">${s.e}</span>${s.n}</div>`).join('')}</div><div id="toolResult"></div>`;
document.querySelectorAll('#sitGrid .tool-sit-card').forEach(c=>c.onclick=()=>runSituational(c.dataset.sit));
break;
case 'screenshotReply':
title.textContent='üì∏ Screenshot Reply';
body.innerHTML=`<label class="tool-label">Upload a chat screenshot</label><div class="tool-upload-area" id="toolUploadArea"><span class="upload-icon">üì∏</span><p>Tap to upload screenshot</p><p style="font-size:.72rem;color:var(--text3);margin-top:4px">AI will read it and suggest replies</p></div><img class="tool-img-preview" id="toolImgPreview" style="display:none"><div id="toolResult"></div>`;
document.getElementById('toolUploadArea').onclick=()=>document.getElementById('mainSSUpload').click();
document.getElementById('mainSSUpload').onchange=handleMainScreenshot;
break;
case 'flowBuilder':
title.textContent='üåä Conversation Flow Builder';
body.innerHTML=`<label class="tool-label">Their opening message</label><input class="tool-input" id="toolInput" placeholder="e.g., heyy whats up"><label class="tool-label">Your goal</label><div class="tool-chips" id="goalChips">${['Get a date','Keep it fun','Be mysterious','Rizz hard','Friend zone escape'].map((g,i)=>`<span class="tool-chip${i===0?' active':''}" data-goal="${g}">${g}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">üåä Build Flow</button><div id="toolResult"></div>`;
document.querySelectorAll('#goalChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#goalChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runFlowBuilder;
break;
case 'compatibility':
title.textContent='üíï Compatibility Analyzer';
body.innerHTML=`<label class="tool-label">Your zodiac / MBTI</label><input class="tool-input" id="toolInput" placeholder="e.g., Leo, INFJ, Scorpio..."><label class="tool-label">Their zodiac / MBTI</label><input class="tool-input" id="toolInput2" placeholder="e.g., Libra, ENFP, Aquarius..."><button class="tool-gen-btn" id="toolGenBtn">üíï Analyze Compatibility</button><div id="toolResult"></div>`;
document.getElementById('toolGenBtn').onclick=runCompatibility;
break;
case 'emojiDecoder':
title.textContent='üß© Emoji Decoder';
body.innerHTML=`<label class="tool-label">Paste emojis or emoji-heavy message</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., üòèüî•üíÄ or üëâüëàü•∫" rows="3"></textarea><button class="tool-gen-btn" id="toolGenBtn">üß© Decode</button><div id="toolResult"></div>`;
document.getElementById('toolGenBtn').onclick=runEmojiDecoder;
break;
case 'dateIdea':
title.textContent='üí° Date Idea Generator';
body.innerHTML=`<label class="tool-label">Budget</label><div class="tool-chips" id="budgetChips">${['Free','Cheap ($)','Moderate ($$)','Fancy ($$$)'].map((b,i)=>`<span class="tool-chip${i===1?' active':''}" data-val="${b}">${b}</span>`).join('')}</div><label class="tool-label">Vibe</label><div class="tool-chips" id="vibeChips">${['Chill','Adventurous','Romantic','Fun & Quirky'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><label class="tool-label">Interests (optional)</label><input class="tool-input" id="toolInput" placeholder="e.g., art, food, nature, gaming"><button class="tool-gen-btn" id="toolGenBtn">üí° Generate Date Ideas</button><div id="toolResult"></div>`;
document.querySelectorAll('#budgetChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#budgetChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.querySelectorAll('#vibeChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#vibeChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runDateIdea;
break;
case 'complimentSched':
title.textContent='‚è∞ Compliment Scheduler';
const scheds=JSON.parse(localStorage.getItem('rizzSchedules')||'[]');
body.innerHTML=`<label class="tool-label">Person's name</label><input class="tool-input" id="toolInput" placeholder="e.g., Sarah"><label class="tool-label">Style</label><div class="tool-chips" id="schedStyleChips">${['sweet','romantic','funny','smooth','bold','spicy'].map((s,i)=>`<span class="tool-chip${i===0?' active':''}" data-style="${s}">${cap(s)}</span>`).join('')}</div><label class="tool-label">Remind me at</label><input class="tool-input" id="toolTimeInput" type="time" value="09:00"><button class="tool-gen-btn" id="toolGenBtn">‚è∞ Schedule Compliment</button><div class="tool-sched-list" id="schedList">${scheds.map((s,i)=>`<div class="tool-sched-item"><span class="sched-time">${s.time}</span><span class="sched-text">${s.name} ‚Ä¢ ${cap(s.style)}</span><button class="tool-sched-del" onclick="deleteSchedule(${i})">‚úï</button></div>`).join('')}</div><div id="toolResult"></div>`;
document.querySelectorAll('#schedStyleChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#schedStyleChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runComplimentSchedule;
break;
case 'redFlag':
title.textContent='üö© Red Flag Detector';
body.innerHTML=`<label class="tool-label">Paste their message or profile text</label><textarea class="tool-textarea" id="toolInput" placeholder="Paste a message, bio, or conversation snippet..." rows="5"></textarea><button class="tool-gen-btn" id="toolGenBtn">üö© Analyze Flags</button><div id="toolResult"></div>`;
document.getElementById('toolGenBtn').onclick=runRedFlagDetector;
break;
case 'saveConvo':
title.textContent='üÜò Save the Convo';
body.innerHTML=`<label class="tool-label">Paste the conversation (or last few messages)</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g.,\nMe: hey you looked nice today\nThem: um ok thanks\nMe: so do you wanna hang out\nThem: idk maybe" rows="5"></textarea><label class="tool-label">What went wrong?</label><div class="tool-chips" id="saveChips">${['It got awkward','They seem annoyed','I said something dumb','Left on read','They lost interest','I overshared'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn" style="background:linear-gradient(135deg,#ef4444,#f59e0b)">üÜò Save My Convo</button><div id="toolResult"></div>`;
document.querySelectorAll('#saveChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#saveChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runSaveConvo;
break;
case 'antiCringe':
title.textContent='üò¨ Anti-Cringe Detector';
body.innerHTML=`<label class="tool-label">What are you about to send?</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., hey beautiful, I've been thinking about you all day and I just want you to know you're the most amazing person I've ever met..." rows="4"></textarea><label class="tool-label">Context (optional)</label><input class="tool-input" id="toolInput2" placeholder="e.g., first date, just met, talking for 2 weeks"><button class="tool-gen-btn" id="toolGenBtn">üò¨ Cringe Check</button><div id="toolResult"></div>`;
document.getElementById('toolGenBtn').onclick=runAntiCringe;
break;
case 'toneTranslator':
title.textContent='üîÑ Tone Translator';
body.innerHTML=`<label class="tool-label">Your message</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., Hey, I had a good time last night. Want to do it again sometime?" rows="3"></textarea><label class="tool-label">Translate to</label><div class="tool-chips" id="toneChips">${['Flirty','Smooth','Funny','Bold','Romantic','Savage','Mysterious','Sweet','Casual','Formal','Poetic','Spicy'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-tone="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">üîÑ Translate Tone</button><div id="toolResult"></div>`;
document.querySelectorAll('#toneChips .tool-chip').forEach(c=>c.onclick=()=>c.classList.toggle('active'));
document.getElementById('toolGenBtn').onclick=runToneTranslator;
break;
case 'perspectiveFlip':
title.textContent='ü™û Perspective Flip';
body.innerHTML=`<label class="tool-label">What are you about to send?</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., so are we going on that date or what? üòè" rows="3"></textarea><label class="tool-label">Their personality (optional)</label><input class="tool-input" id="toolInput2" placeholder="e.g., shy introvert, confident girl, sarcastic guy"><button class="tool-gen-btn" id="toolGenBtn">ü™û Flip Perspective</button><div id="toolResult"></div>`;
document.getElementById('toolGenBtn').onclick=runPerspectiveFlip;
break;
case 'ghostRecovery':
title.textContent='üëª Ghosting Recovery Kit';
body.innerHTML=`<label class="tool-label">Paste your last messages before being ghosted</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g.,\nMe: hey how was your day?\nMe: hello?\nMe: guess you're busy" rows="4"></textarea><label class="tool-label">How long ghosted?</label><div class="tool-chips" id="ghostChips">${['1-2 days','3-5 days','1 week','2+ weeks','1+ month'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><label class="tool-label">Your goal</label><div class="tool-chips" id="ghostGoalChips">${['Get them back','Stay cool','Move on with dignity','Make them regret it','Friendly check-in'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn" style="background:linear-gradient(135deg,#6366f1,#a855f7)">üëª Generate Comeback</button><div id="toolResult"></div>`;
document.querySelectorAll('#ghostChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#ghostChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.querySelectorAll('#ghostGoalChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#ghostGoalChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runGhostRecovery;
break;
case 'rizzRater':
title.textContent='‚≠ê Rizz Rater';
body.innerHTML=`<label class="tool-label">Paste your message or pickup line</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., If beauty were a crime, you'd be serving a life sentence" rows="3"></textarea><label class="tool-label">Context</label><div class="tool-chips" id="rateContextChips">${['Tinder DM','Instagram DM','IRL approach','Text message','First message','Reply to their story'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">‚≠ê Rate My Rizz</button><div id="toolResult"></div>`;
document.querySelectorAll('#rateContextChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#rateContextChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runRizzRater;
break;
case 'bioBeforeAfter':
title.textContent='üìä Bio Before & After';
body.innerHTML=`<label class="tool-label">Paste your current bio</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., Just a chill guy who likes music and food. Looking for someone cool." rows="4"></textarea><label class="tool-label">Platform</label><div class="tool-chips" id="bioPlatChips">${['Tinder','Bumble','Hinge','Instagram','Twitter/X','LinkedIn Dating'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">üìä Transform Bio</button><div id="toolResult"></div>`;
document.querySelectorAll('#bioPlatChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#bioPlatChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runBioBeforeAfter;
break;
case 'dateScript':
title.textContent='üé¨ First Date Script';
body.innerHTML=`<label class="tool-label">Date type</label><div class="tool-chips" id="dateTypeChips">${['Coffee Date','Dinner Date','Walk/Park Date','Bar/Drinks','Activity Date','Virtual Date'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><label class="tool-label">Your personality</label><div class="tool-chips" id="datePersonChips">${['Introverted','Extroverted','Funny','Romantic','Nerdy','Adventurous'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><label class="tool-label">Their interests (optional)</label><input class="tool-input" id="toolInput" placeholder="e.g., music, travel, cooking, fitness"><button class="tool-gen-btn" id="toolGenBtn">üé¨ Generate Script</button><div id="toolResult"></div>`;
document.querySelectorAll('#dateTypeChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#dateTypeChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.querySelectorAll('#datePersonChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#datePersonChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runDateScript;
break;
case 'trendingLines':
title.textContent='üìà Trending Lines';
body.innerHTML=`<label class="tool-label">Category</label><div class="tool-chips" id="trendCatChips">${['Pop Culture','Memes','Movies/TV','Music','Sports','Tech/Gaming','Bollywood','Anime','Holiday/Seasonal'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><label class="tool-label">Style</label><div class="tool-chips" id="trendStyleChips">${['Smooth','Funny','Flirty','Bold','Nerdy'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">üìà Get Trending Lines</button><div id="toolResult"></div>`;
document.querySelectorAll('#trendCatChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#trendCatChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.querySelectorAll('#trendStyleChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#trendStyleChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runTrendingLines;
break;
case 'msgDecoder':
title.textContent='üîç Message Decoder';
body.innerHTML=`<label class="tool-label">Paste their confusing message</label><textarea class="tool-textarea" id="toolInput" placeholder="e.g., yeah sure we can hang out sometime lol" rows="3"></textarea><label class="tool-label">Your relationship</label><div class="tool-chips" id="decoderChips">${['Just met','Talking stage','Dating','Ex','Friend zone','Situationship'].map((v,i)=>`<span class="tool-chip${i===0?' active':''}" data-val="${v}">${v}</span>`).join('')}</div><button class="tool-gen-btn" id="toolGenBtn">üîç Decode Message</button><div id="toolResult"></div>`;
document.querySelectorAll('#decoderChips .tool-chip').forEach(c=>c.onclick=()=>{document.querySelectorAll('#decoderChips .tool-chip').forEach(x=>x.classList.remove('active'));c.classList.add('active');});
document.getElementById('toolGenBtn').onclick=runMsgDecoder;
break;
}
overlay.style.display='flex';
}
function closeTool(){document.getElementById('toolOverlay').style.display='none';}

// ===== TOOL: PROFILE ROAST =====
async function runProfileRoast(){
const bio=document.getElementById('toolInput').value.trim();
if(!bio){showToast('Paste your bio first!');return;}
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Roasting...';
try{
const msgs=[{role:'system',content:'You are a brutally honest but helpful dating profile reviewer. First ROAST the bio (be savage and funny, 2-3 lines). Then give a SCORE out of 10. Then provide an IMPROVED VERSION of their bio. Then give 3 SPECIFIC TIPS. Format with clear sections using ** headers.'},{role:'user',content:`Roast and review this dating profile bio:\n"${bio}"`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Couldn't roast right now. Try again!</div>`;}
btn.disabled=false;btn.textContent='üî• Roast My Profile';
}

// ===== TOOL: BIO SUGGEST =====
async function runBioSuggest(){
const bio=document.getElementById('toolInput').value.trim();
const vibeEl=document.querySelector('#bioVibeChips .tool-chip.active');
const vibe=vibeEl?vibeEl.dataset.vibe:'Funny';
const btn=document.getElementById('toolSuggestBtn');btn.disabled=true;btn.textContent='Generating...';
try{
const context=bio?`The user currently has this bio: "${bio}". Use it as inspiration to understand their personality, interests, and tone.`:`The user hasn't written a bio yet. Create bios from scratch.`;
const msgs=[{role:'system',content:`You are a world-class dating profile bio writer. ${context} Generate exactly 5 unique, creative dating profile bios in a **${vibe}** vibe/tone. Each bio should be 1-3 lines max, catchy, memorable, and swipe-right worthy. Make each one feel distinct ‚Äî vary structure, humor, and style within the ${vibe} tone. Number them 1-5. After each bio add a short tag like (Best for Tinder), (Best for Hinge), (Best for Bumble), (Works everywhere), or (Instagram ready). End with a brief tip on which bio suits which platform.`},{role:'user',content:`Generate 5 ${vibe.toLowerCase()} dating profile bios${bio?' based on: "'+bio+'"':' for someone looking for a great bio'}`}];
const res=await callAIRaw(msgs);
let html=`<div class="tool-result" style="animation:fadeUp .3s">`;
html+=formatToolResult(res);
html+=`</div>`;
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Couldn't generate bios right now. Try again!</div>`;}
btn.disabled=false;btn.textContent='‚ú® Suggest 5 Bios';
}

// ===== TOOL: RESPONSE PREDICTOR =====
async function runResponsePredictor(){
const msg=document.getElementById('toolInput').value.trim();
if(!msg){showToast('Enter what you sent!');return;}
const personality=document.getElementById('toolInput2')?.value||'';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Predicting...';
try{
const msgs=[{role:'system',content:`You predict how someone will reply to a text message. ${personality?'Their personality: '+personality+'.':''} Give 5 possible responses ranging from best case to worst case. For each, give a probability %, the predicted reply, and what to reply back. Format clearly with numbered predictions.`},{role:'user',content:`Predict responses to: "${msg}"`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Prediction failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üîÆ Predict Response';
}

// ===== TOOL: LINE REMIXER =====
async function runRemixer(){
const line=document.getElementById('toolInput').value.trim();
if(!line){showToast('Enter a line to remix!');return;}
const activeStyles=[...document.querySelectorAll('#remixChips .tool-chip.active')].map(c=>c.dataset.style);
if(!activeStyles.length){showToast('Select at least one style!');return;}
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Remixing...';
try{
const msgs=[{role:'system',content:`You remix pickup lines into different styles. Take the given line and rewrite it in each of these styles: ${activeStyles.join(', ')}. Keep the core idea but transform the delivery. Label each with the style name.`},{role:'user',content:`Remix this line: "${line}"`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Remix failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üéµ Remix It';
}

// ===== TOOL: SITUATIONAL RIZZ =====
async function runSituational(situation){
document.querySelectorAll('#sitGrid .tool-sit-card').forEach(c=>c.style.opacity=c.dataset.sit===situation?'1':'0.5');
const res=document.getElementById('toolResult');
res.innerHTML='<div class="tool-result" style="text-align:center">Generating lines for '+situation+'...</div>';
try{
const msgs=[{role:'system',content:`Generate 5 creative, natural pickup lines or conversation starters specifically for meeting someone at a ${situation}. Make them contextual ‚Äî reference things you'd actually find at that location. Mix smooth, funny, and bold. Number them 1-5.`},{role:'user',content:`Give me rizz lines for: ${situation}`}];
const text=await callAIRaw(msgs);
res.innerHTML=`<div class="tool-result">${formatToolResult(text)}</div>`;
playSound('generate');
}catch(e){res.innerHTML=`<div class="tool-result">Failed. Tap another situation!</div>`;}
}

// ===== TOOL: SCREENSHOT REPLY (MAIN PAGE) =====
function initMainScreenshot(){}
async function handleMainScreenshot(e){
const file=e.target.files?.[0];
if(!file)return;
const preview=document.getElementById('toolImgPreview');
preview.src=URL.createObjectURL(file);preview.style.display='block';
const res=document.getElementById('toolResult');
res.innerHTML='<div class="tool-result" style="text-align:center">üîç Reading screenshot with OCR...</div>';
try{
const script=document.createElement('script');
if(!window.Tesseract){
script.src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
document.head.appendChild(script);
await new Promise(r=>script.onload=r);
}
const{data}=await Tesseract.recognize(file,'eng');
const text=data.text.trim();
if(!text){res.innerHTML='<div class="tool-result">Could not read text from image. Try a clearer screenshot.</div>';return;}
const msgs=[{role:'system',content:'You are a texting expert. The user uploaded a chat screenshot. The OCR text is below. Analyze the conversation and suggest 5 great reply options in different styles (smooth, funny, bold, flirty, savage). Number them 1-5.'},{role:'user',content:`Chat text from screenshot:\n${text}`}];
const aiRes=await callAIRaw(msgs);
res.innerHTML=`<div class="tool-result"><h4>üì∏ Detected Text:</h4><p style="color:var(--text3);margin-bottom:12px;font-size:.82rem">${escHtml(text).substring(0,300)}...</p><h4>üí¨ Suggested Replies:</h4>${formatToolResult(aiRes)}</div>`;
playSound('generate');
}catch(err){res.innerHTML=`<div class="tool-result">Error reading screenshot. Try again!</div>`;}
e.target.value='';
}

// ===== TOOL: CONVERSATION FLOW BUILDER =====
async function runFlowBuilder(){
const opener=document.getElementById('toolInput').value.trim();
if(!opener){showToast('Enter their message!');return;}
const goal=document.querySelector('#goalChips .tool-chip.active')?.dataset.goal||'Get a date';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Building flow...';
try{
const msgs=[{role:'system',content:`You are a conversation strategist. Build a conversation flow tree. Start with their message, then show 3 possible replies from "me". For each reply, predict their next response and give a follow-up. Format as a structured tree:
THEM: [message]
‚Üí OPTION A: [reply]
  THEM: [predicted response]
  ‚Üí FOLLOW UP: [your next move]
‚Üí OPTION B: [reply]
  THEM: [predicted response]
  ‚Üí FOLLOW UP: [your next move]
‚Üí OPTION C: [reply]
  THEM: [predicted response]
  ‚Üí FOLLOW UP: [your next move]
Goal: ${goal}. Make it practical and realistic.`},{role:'user',content:`Build a conversation flow starting with: "${opener}"`}];
const res=await callAIRaw(msgs);
const html=res.split('\n').map(line=>{
const trimmed=line.trim();
if(trimmed.startsWith('THEM:'))return`<div class="flow-node them">üí¨ ${escHtml(trimmed)}</div>`;
if(trimmed.startsWith('‚Üí OPTION')||trimmed.startsWith('‚Üí FOLLOW'))return`<div class="flow-node me">‚ö° ${escHtml(trimmed.replace('‚Üí','').trim())}</div>`;
if(trimmed.startsWith('THEM:'))return`<div class="flow-node them">${escHtml(trimmed)}</div>`;
if(trimmed.length>2)return`<div class="flow-node">${escHtml(trimmed)}</div>`;
return'';
}).join('');
document.getElementById('toolResult').innerHTML=`<div class="tool-flow-tree">${html}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Flow building failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üåä Build Flow';
}

// ===== TOOL: COMPATIBILITY ANALYZER =====
async function runCompatibility(){
const you=document.getElementById('toolInput').value.trim();
const them=document.getElementById('toolInput2').value.trim();
if(!you||!them){showToast('Enter both signs/types!');return;}
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Analyzing...';
try{
const msgs=[{role:'system',content:'You are a fun compatibility analyzer. Analyze the zodiac/MBTI compatibility. Return ONLY valid JSON: {"score":78,"chemistry":"Electric","strengths":["Great communication","Shared humor"],"challenges":["Stubbornness"],"firstDate":"A fun description","pickupLine":"A custom pickup line using both signs","verdict":"Overall verdict in 2 sentences"}'},{role:'user',content:`Compatibility: ${you} + ${them}`}];
const text=await callAIRaw(msgs);
const json=JSON.parse(text.match(/\{[\s\S]*\}/)?.[0]||'{}');
const score=json.score||Math.floor(Math.random()*40)+50;
document.getElementById('toolResult').innerHTML=`<div class="tool-result">
<h4>üíï ${you} √ó ${them}</h4>
<div style="font-size:2.5rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center;margin:10px 0">${score}%</div>
<div class="tool-compat-bar"><div class="tool-compat-fill" style="width:${score}%"></div></div>
<p><strong>Chemistry:</strong> ${json.chemistry||'Interesting'}</p>
<p style="margin-top:8px"><strong>Strengths:</strong> ${(json.strengths||[]).join(', ')}</p>
<p style="margin-top:8px"><strong>Challenges:</strong> ${(json.challenges||[]).join(', ')}</p>
<p style="margin-top:8px"><strong>Perfect First Date:</strong> ${json.firstDate||'Something fun'}</p>
<p style="margin-top:8px"><strong>Custom Pickup Line:</strong> <em>${json.pickupLine||''}</em></p>
<p style="margin-top:8px"><strong>Verdict:</strong> ${json.verdict||''}</p>
</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Analysis failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üíï Analyze Compatibility';
}

// ===== TOOL: EMOJI DECODER =====
async function runEmojiDecoder(){
const emojis=document.getElementById('toolInput').value.trim();
if(!emojis){showToast('Enter some emojis!');return;}
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Decoding...';
try{
const msgs=[{role:'system',content:'You are an emoji decoder expert for dating/texting. Decode the hidden meaning behind emoji combinations. Give: 1) The literal decode, 2) The REAL hidden meaning in dating context, 3) Flirt level (1-10), 4) What they actually want, 5) Best emoji reply combo to send back, 6) A text reply suggestion. Be fun and insightful.'},{role:'user',content:`Decode these emojis in dating context: ${emojis}`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Decode failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üß© Decode';
}

// ===== TOOL: DATE IDEA GENERATOR =====
async function runDateIdea(){
const budget=document.querySelector('#budgetChips .tool-chip.active')?.dataset.val||'Cheap';
const vibe=document.querySelector('#vibeChips .tool-chip.active')?.dataset.val||'Chill';
const interests=document.getElementById('toolInput')?.value||'';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Planning...';
try{
const msgs=[{role:'system',content:`Generate 5 creative date ideas. Budget: ${budget}. Vibe: ${vibe}. ${interests?'Interests: '+interests+'.' :''} For each date idea give: Name (creative/fun name), Description (2-3 sentences), Why it works (1 sentence), Pro tip (1 sentence). Number them 1-5. Be creative and unique ‚Äî avoid generic answers.`},{role:'user',content:'Generate 5 unique date ideas'}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Planning failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üí° Generate Date Ideas';
}

// ===== TOOL: COMPLIMENT SCHEDULER =====
function runComplimentSchedule(){
const name=document.getElementById('toolInput').value.trim();
if(!name){showToast('Enter their name!');return;}
const style=document.querySelector('#schedStyleChips .tool-chip.active')?.dataset.style||'sweet';
const time=document.getElementById('toolTimeInput')?.value||'09:00';
const scheds=JSON.parse(localStorage.getItem('rizzSchedules')||'[]');
scheds.push({name,style,time,created:Date.now()});
localStorage.setItem('rizzSchedules',JSON.stringify(scheds));
const list=document.getElementById('schedList');
list.innerHTML=scheds.map((s,i)=>`<div class="tool-sched-item"><span class="sched-time">${s.time}</span><span class="sched-text">${s.name} ‚Ä¢ ${cap(s.style)}</span><button class="tool-sched-del" onclick="deleteSchedule(${i})">‚úï</button></div>`).join('');
showToast(`‚è∞ Scheduled for ${name} at ${time}`);
playSound('generate');
genAndShowCompliment(name,style);
}
async function genAndShowCompliment(name,sty){
const res=document.getElementById('toolResult');
res.innerHTML='<div class="tool-result">Generating compliment preview...</div>';
try{
const msgs=[{role:'system',content:`Generate 3 ${sty} compliments for someone named ${name}. Make them feel special. One per line.`},{role:'user',content:`Generate ${sty} compliments for ${name}`}];
const text=await callAIRaw(msgs);
res.innerHTML=`<div class="tool-result"><h4>Preview compliments for ${name}:</h4>${formatToolResult(text)}</div>`;
}catch(e){res.innerHTML='';}
}
function deleteSchedule(idx){
const scheds=JSON.parse(localStorage.getItem('rizzSchedules')||'[]');
scheds.splice(idx,1);
localStorage.setItem('rizzSchedules',JSON.stringify(scheds));
const list=document.getElementById('schedList');
if(list)list.innerHTML=scheds.map((s,i)=>`<div class="tool-sched-item"><span class="sched-time">${s.time}</span><span class="sched-text">${s.name} ‚Ä¢ ${cap(s.style)}</span><button class="tool-sched-del" onclick="deleteSchedule(${i})">‚úï</button></div>`).join('');
showToast('Schedule removed');
}
function checkScheduledCompliments(){
const scheds=JSON.parse(localStorage.getItem('rizzSchedules')||'[]');
if(!scheds.length)return;
const now=new Date();
const hhmm=now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
scheds.forEach(s=>{
if(s.time===hhmm){
if('Notification' in window && Notification.permission==='granted'){
new Notification(`üíú Compliment time for ${s.name}!`,{body:`Send a ${s.style} compliment to ${s.name}`,icon:'icon-192.svg'});
}else showToast(`üíú Time to compliment ${s.name}!`);
}
});
if('Notification' in window && Notification.permission==='default')Notification.requestPermission();
setInterval(checkScheduledCompliments,60000);
}

// ===== TOOL: RED FLAG DETECTOR =====
async function runRedFlagDetector(){
const text=document.getElementById('toolInput').value.trim();
if(!text){showToast('Paste their message/profile!');return;}
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Analyzing...';
try{
const msgs=[{role:'system',content:'You are a dating red flag / green flag detector. Analyze the text and identify red flags üö©, yellow flags ‚ö†Ô∏è, and green flags ‚úÖ. Return ONLY valid JSON: {"redFlags":[{"flag":"description","severity":"high/medium"}],"yellowFlags":[{"flag":"description"}],"greenFlags":[{"flag":"description"}],"overallScore":7,"verdict":"Overall assessment in 2-3 sentences","advice":"What to do next"}'},{role:'user',content:`Analyze for flags:\n"${text}"`}];
const res=await callAIRaw(msgs);
const json=JSON.parse(res.match(/\{[\s\S]*\}/)?.[0]||'{}');
let html='<div class="tool-result">';
html+=`<div style="text-align:center;font-size:2rem;font-weight:800;margin-bottom:10px">${json.overallScore||5}/10</div>`;
if(json.redFlags?.length){html+='<h4 style="color:#ef4444">üö© Red Flags</h4>';json.redFlags.forEach(f=>{html+=`<div class="tool-flag red">${f.flag} ${f.severity==='high'?'‚ö†Ô∏è':''}</div>`;});}
if(json.yellowFlags?.length){html+='<h4 style="color:#f59e0b;margin-top:12px">‚ö†Ô∏è Yellow Flags</h4>';json.yellowFlags.forEach(f=>{html+=`<div class="tool-flag yellow">${f.flag}</div>`;});}
if(json.greenFlags?.length){html+='<h4 style="color:#22c55e;margin-top:12px">‚úÖ Green Flags</h4>';json.greenFlags.forEach(f=>{html+=`<div class="tool-flag green">${f.flag}</div>`;});}
html+=`<p style="margin-top:14px"><strong>Verdict:</strong> ${json.verdict||''}</p>`;
html+=`<p style="margin-top:8px"><strong>Advice:</strong> ${json.advice||''}</p></div>`;
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Analysis failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üö© Analyze Flags';
}

// ===== TOOL: SAVE THE CONVO =====
async function runSaveConvo(){
const convo=document.getElementById('toolInput').value.trim();
if(!convo){showToast('Paste the conversation first!');return;}
const problem=document.querySelector('#saveChips .tool-chip.active')?.dataset.val||'It got awkward';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Saving...';
try{
const msgs=[{role:'system',content:`You are an emergency conversation recovery expert. The user's conversation went wrong because: "${problem}". Analyze what went wrong and provide EXACTLY this format:

**üîé What Went Wrong:**
[1-2 sentences analyzing the issue]

**üÜò Recovery Messages (pick one to send):**
1. [smooth recovery message]
2. [funny/light recovery message]
3. [honest/vulnerable recovery message]
4. [bold confident recovery message]
5. [casual cool recovery message]

**‚è∞ Timing Advice:**
[When to send it ‚Äî immediately, wait a few hours, etc.]

**üéØ Strategy:**
[2-3 sentences on how to steer the convo back on track after sending]

Keep recovery messages short (1-2 sentences), natural, and NOT desperate. They should feel like a smooth redirect, not an apology tour.`},{role:'user',content:`Save this conversation. Problem: ${problem}\n---\n${convo}`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Couldn't save this one. Try again!</div>`;}
btn.disabled=false;btn.textContent='üÜò Save My Convo';
}

// ===== TOOL: ANTI-CRINGE DETECTOR =====
async function runAntiCringe(){
const text=document.getElementById('toolInput').value.trim();
if(!text){showToast('Type what you want to send!');return;}
const context=document.getElementById('toolInput2')?.value||'';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Analyzing...';
try{
const msgs=[{role:'system',content:`You are the Anti-Cringe Detector. Analyze the message someone is about to send and return ONLY valid JSON in this exact format:
{"score":75,"verdict":"fire","meter":"üî•üî•üî•üî•","analysis":"Why this message works or doesn't work in 2-3 sentences.","cringeFactors":["factor 1 if any"],"fireFactors":["what makes it good"],"improvedVersion":"A better version of their message if needed","shouldSend":true,"confidence":"high"}

Score: 0-100 (0=maximum cringe, 100=maximum fire)
Verdict: one of "cringe", "mid", "decent", "solid", "fire"
Meter: use üíÄ for cringe, üòê for mid, üëç for decent, üî• for fire (1-5 icons matching score)
shouldSend: boolean
confidence: "low", "medium", "high"
${context?'Context: '+context:''}`},{role:'user',content:`Cringe check this message:\n"${text}"`}];
const res=await callAIRaw(msgs);
const json=JSON.parse(res.match(/\{[\s\S]*\}/)?.[0]||'{}');
const score=json.score||50;
const color=score>=80?'#22c55e':score>=60?'#f59e0b':score>=40?'#f97316':'#ef4444';
let html='<div class="tool-result">';
html+=`<div style="text-align:center;margin-bottom:16px"><div style="font-size:2.5rem;margin-bottom:4px">${json.meter||'üòêüòêüòê'}</div><div style="font-size:2rem;font-weight:900;color:${color}">${score}/100</div><div style="font-size:1.1rem;font-weight:700;text-transform:uppercase;color:${color};letter-spacing:1px">${json.verdict||'mid'}</div></div>`;
html+=`<div style="width:100%;height:8px;background:rgba(255,255,255,.1);border-radius:99px;margin-bottom:16px;overflow:hidden"><div style="width:${score}%;height:100%;background:${color};border-radius:99px;transition:width .5s"></div></div>`;
html+=`<p style="margin-bottom:12px">${json.analysis||''}</p>`;
if(json.cringeFactors?.length&&json.cringeFactors[0]){html+='<h4 style="color:#ef4444">üíÄ Cringe Factors</h4>';json.cringeFactors.forEach(f=>{html+=`<p style="margin-bottom:4px">‚Ä¢ ${f}</p>`;});}
if(json.fireFactors?.length&&json.fireFactors[0]){html+='<h4 style="color:#22c55e;margin-top:10px">üî• Fire Factors</h4>';json.fireFactors.forEach(f=>{html+=`<p style="margin-bottom:4px">‚Ä¢ ${f}</p>`;});}
if(json.improvedVersion){html+=`<h4 style="margin-top:12px">‚ú® Improved Version</h4><div style="padding:12px;background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.2);border-radius:10px;margin-top:6px;cursor:pointer" onclick="copyText('${json.improvedVersion.replace(/'/g,"\\'")}')">${json.improvedVersion} <span style="font-size:.7rem;color:var(--text3)">tap to copy</span></div>`;}
html+=`<div style="text-align:center;margin-top:14px;padding:10px;border-radius:10px;background:${json.shouldSend?'rgba(34,197,94,.08)':'rgba(239,68,68,.08)'};border:1px solid ${json.shouldSend?'rgba(34,197,94,.2)':'rgba(239,68,68,.2)'}"><strong>${json.shouldSend?'‚úÖ SEND IT':'‚ùå DON\'T SEND'}</strong> <span style="color:var(--text2);font-size:.85rem">(${json.confidence||'medium'} confidence)</span></div>`;
html+='</div>';
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Analysis failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üò¨ Cringe Check';
}

// ===== TOOL: TONE TRANSLATOR =====
async function runToneTranslator(){
const text=document.getElementById('toolInput').value.trim();
if(!text){showToast('Type your message first!');return;}
const activeTones=[...document.querySelectorAll('#toneChips .tool-chip.active')].map(c=>c.dataset.tone);
if(!activeTones.length){showToast('Pick at least one tone!');return;}
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Translating...';
try{
const msgs=[{role:'system',content:`You are a Tone Translator. Take the user's message and rewrite it in each requested tone/style. For each tone, provide:
- The translated message (1-2 sentences, natural and sendable)
- A brief note on why this tone works

Format each as:
**[TONE EMOJI] [Tone Name]:**
"[translated message]"
_Why it works: [brief note]_

Tones to translate to: ${activeTones.join(', ')}

Keep translations short, punchy, and actually sendable. Not generic ‚Äî tailor to the original message's intent.`},{role:'user',content:`Translate this message:\n"${text}"`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Translation failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üîÑ Translate Tone';
}

// ===== TOOL: PERSPECTIVE FLIP =====
async function runPerspectiveFlip(){
const text=document.getElementById('toolInput').value.trim();
if(!text){showToast('Type your message first!');return;}
const personality=document.getElementById('toolInput2')?.value||'';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Flipping...';
try{
const msgs=[{role:'system',content:`You are a Perspective Flip expert. You simulate how the RECEIVER would react to a message. ${personality?'Their personality: '+personality+'.':'Assume a typical person in the dating/talking stage.'} Return ONLY valid JSON:
{"firstImpression":"Their instant gut reaction in 1 sentence","emotionalReaction":"How it makes them feel (1-2 sentences)","whatTheyThink":"Their internal monologue/thoughts (2-3 sentences, write in first person as them)","interestLevel":7,"interestChange":"up","replyLikelihood":80,"likelyReplies":["most likely reply 1","likely reply 2","possible reply 3"],"redFlags":["any part of the message that might put them off"],"greenFlags":["parts that would impress them"],"verdict":"Overall impression in 1-2 sentences","tip":"One specific tip to improve this message"}

interestLevel: 1-10
interestChange: "up", "down", or "neutral"
replyLikelihood: 0-100%`},{role:'user',content:`How would they react to this message?\n"${text}"`}];
const res=await callAIRaw(msgs);
const json=JSON.parse(res.match(/\{[\s\S]*\}/)?.[0]||'{}');
const interest=json.interestLevel||5;
const iColor=interest>=7?'#22c55e':interest>=5?'#f59e0b':'#ef4444';
const arrow=json.interestChange==='up'?'üìà':json.interestChange==='down'?'üìâ':'‚û°Ô∏è';
let html='<div class="tool-result">';
html+=`<div style="text-align:center;margin-bottom:14px"><div style="font-size:.75rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Interest Level</div><div style="font-size:2.2rem;font-weight:900;color:${iColor}">${interest}/10 ${arrow}</div><div style="font-size:.85rem;color:var(--text2)">${json.replyLikelihood||50}% chance of reply</div></div>`;
html+=`<h4>üí≠ First Impression</h4><p style="margin-bottom:10px">${json.firstImpression||''}</p>`;
html+=`<h4>üòä How It Makes Them Feel</h4><p style="margin-bottom:10px">${json.emotionalReaction||''}</p>`;
html+=`<h4>üß† Their Internal Monologue</h4><div style="padding:12px;background:rgba(99,102,241,.06);border:1px solid rgba(99,102,241,.15);border-radius:10px;margin-bottom:10px;font-style:italic">"${json.whatTheyThink||''}"</div>`;
if(json.likelyReplies?.length){html+='<h4>üí¨ How They\'d Likely Reply</h4>';json.likelyReplies.forEach((r,i)=>{html+=`<div style="padding:8px 12px;background:rgba(255,255,255,.03);border-radius:10px;margin-bottom:4px;font-size:.88rem"><strong>${i+1}.</strong> "${r}"</div>`;});}
if(json.greenFlags?.length&&json.greenFlags[0]){html+='<h4 style="color:#22c55e;margin-top:10px">‚úÖ What They\'d Like</h4>';json.greenFlags.forEach(f=>{html+=`<p style="margin-bottom:3px">‚Ä¢ ${f}</p>`;});}
if(json.redFlags?.length&&json.redFlags[0]){html+='<h4 style="color:#ef4444;margin-top:10px">‚ö†Ô∏è What Might Put Them Off</h4>';json.redFlags.forEach(f=>{html+=`<p style="margin-bottom:3px">‚Ä¢ ${f}</p>`;});}
html+=`<div style="margin-top:12px;padding:10px;background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.15);border-radius:10px"><strong>üéØ Verdict:</strong> ${json.verdict||''}</div>`;
if(json.tip){html+=`<div style="margin-top:8px;padding:10px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:10px"><strong>üí° Tip:</strong> ${json.tip}</div>`;}
html+='</div>';
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Couldn't flip perspective. Try again!</div>`;}
btn.disabled=false;btn.textContent='ü™û Flip Perspective';
}

// ===== TOOL: GHOSTING RECOVERY KIT =====
async function runGhostRecovery(){
const convo=document.getElementById('toolInput').value.trim();
if(!convo){showToast('Paste your last messages!');return;}
const duration=document.querySelector('#ghostChips .tool-chip.active')?.dataset.val||'1-2 days';
const goal=document.querySelector('#ghostGoalChips .tool-chip.active')?.dataset.val||'Get them back';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Crafting comeback...';
try{
const msgs=[{role:'system',content:`You are a Ghosting Recovery specialist. The user has been ghosted for ${duration}. Their goal: ${goal}. Analyze the conversation and provide a comeback strategy.

Format EXACTLY like this:

**üëª Ghost Analysis:**
[Why they probably ghosted ‚Äî 2-3 sentences, be honest but not harsh]

**üìä Recovery Chances:**
[X]% ‚Äî [brief reason]

**üí¨ Comeback Messages (ranked best to worst):**
1. üèÜ [BEST ‚Äî the smoothest, most effective comeback message]
2. üòé [COOL ‚Äî casual and unbothered]
3. üòÇ [FUNNY ‚Äî humor-based reengagement]
4. üí™ [BOLD ‚Äî confident and direct]
5. üéØ [HAIL MARY ‚Äî risky but could work]

**‚è∞ When to Send:**
[Specific timing advice]

**üìã Game Plan:**
- [Step 1 after they reply]
- [Step 2]
- [What to do if they don't reply]

**üö´ What NOT to Do:**
- [Common mistake 1]
- [Common mistake 2]

Keep comeback messages SHORT (1 sentence), natural, and NOT desperate. They should make the other person curious or smile.`},{role:'user',content:`I've been ghosted for ${duration}. Goal: ${goal}.\nLast messages:\n---\n${convo}`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Recovery failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üëª Generate Comeback';
}

// ===== TOOL: RIZZ RATER =====
async function runRizzRater(){
const text=document.getElementById('toolInput').value.trim();
if(!text){showToast('Paste your message first!');return;}
const context=document.querySelector('#rateContextChips .tool-chip.active')?.dataset.val||'Text message';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Rating...';
try{
const msgs=[{role:'system',content:`You are the Rizz Rater ‚Äî the ultimate judge of smooth talk. Rate the user's message/line for a "${context}" context. Return ONLY valid JSON:
{"rizzScore":85,"grade":"S","title":"Smooth Operator","breakdown":{"confidence":8,"creativity":9,"humor":7,"smoothness":9,"effectiveness":8},"reaction":"How the receiver would likely react (1 sentence)","strengths":["strength 1","strength 2"],"weaknesses":["weakness if any"],"improvedVersion":"A version that would score higher","funComment":"A funny 1-liner comment about their rizz level"}

rizzScore: 0-100
grade: "F", "D", "C", "B", "A", "S", "S+" (like gaming ranks)
breakdown scores: each 1-10
title: a fun title like "Smooth Operator", "Cringe Lord", "Rizz God", "Average Andy", "Flirt Machine" etc.`},{role:'user',content:`Rate this rizz (context: ${context}):\n"${text}"`}];
const res=await callAIRaw(msgs);
const json=JSON.parse(res.match(/\{[\s\S]*\}/)?.[0]||'{}');
const score=json.rizzScore||50;
const gradeColors={'S+':'#fbbf24','S':'#f59e0b','A':'#22c55e','B':'#3b82f6','C':'#f59e0b','D':'#f97316','F':'#ef4444'};
const gc=gradeColors[json.grade]||'#a855f7';
const bd=json.breakdown||{};
let html='<div class="tool-result">';
html+=`<div style="text-align:center;margin-bottom:16px"><div style="font-size:3rem;font-weight:900;color:${gc};line-height:1">${json.grade||'B'}</div><div style="font-size:1.8rem;font-weight:800;margin-top:4px">${score}/100</div><div style="font-size:.9rem;color:var(--accent);font-weight:600;margin-top:2px">${json.title||'Rated'}</div></div>`;
html+=`<div style="width:100%;height:10px;background:rgba(255,255,255,.1);border-radius:99px;margin-bottom:16px;overflow:hidden"><div style="width:${score}%;height:100%;background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e);border-radius:99px"></div></div>`;
const stats=[['Confidence',bd.confidence],['Creativity',bd.creativity],['Humor',bd.humor],['Smoothness',bd.smoothness],['Effectiveness',bd.effectiveness]];
html+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px">';
stats.forEach(([name,val])=>{if(val){const v=val*10;const c=v>=70?'#22c55e':v>=50?'#f59e0b':'#ef4444';html+=`<div style="padding:8px;background:rgba(255,255,255,.03);border-radius:8px"><div style="font-size:.7rem;color:var(--text3);margin-bottom:4px">${name}</div><div style="display:flex;align-items:center;gap:6px"><div style="flex:1;height:4px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden"><div style="width:${v}%;height:100%;background:${c};border-radius:99px"></div></div><span style="font-size:.75rem;font-weight:700;color:${c}">${val}/10</span></div></div>`;}});
html+='</div>';
if(json.funComment){html+=`<div style="text-align:center;padding:10px;background:rgba(168,85,247,.08);border-radius:10px;margin-bottom:12px;font-style:italic;color:var(--accent)">"${json.funComment}"</div>`;}
html+=`<p style="margin-bottom:10px"><strong>üéØ Reaction:</strong> ${json.reaction||''}</p>`;
if(json.strengths?.length){html+='<h4 style="color:#22c55e">üí™ Strengths</h4>';json.strengths.forEach(s=>{html+=`<p style="margin-bottom:3px">‚Ä¢ ${s}</p>`;});}
if(json.weaknesses?.length&&json.weaknesses[0]){html+='<h4 style="color:#f59e0b;margin-top:8px">‚ö° Could Improve</h4>';json.weaknesses.forEach(w=>{html+=`<p style="margin-bottom:3px">‚Ä¢ ${w}</p>`;});}
if(json.improvedVersion){html+=`<h4 style="margin-top:10px">üöÄ Upgraded Version</h4><div style="padding:12px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:10px;margin-top:6px;cursor:pointer" onclick="copyText('${json.improvedVersion.replace(/'/g,"\\'")}')">${json.improvedVersion} <span style="font-size:.7rem;color:var(--text3)">tap to copy</span></div>`;}
html+='</div>';
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Rating failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='‚≠ê Rate My Rizz';
}

// ===== TOOL: BIO BEFORE & AFTER =====
async function runBioBeforeAfter(){
const bio=document.getElementById('toolInput').value.trim();
if(!bio){showToast('Paste your current bio!');return;}
const platform=document.querySelector('#bioPlatChips .tool-chip.active')?.dataset.val||'Tinder';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Transforming...';
try{
const msgs=[{role:'system',content:`You are a dating profile transformation expert. Take the user's current bio and create a dramatically improved version optimized for ${platform}. Return ONLY valid JSON:
{"currentScore":4,"improvedScore":9,"problems":["problem 1 with current bio","problem 2"],"improved":"The dramatically improved bio text","changes":[{"what":"What was changed","why":"Why it's better"}],"platformTips":["tip specific to ${platform}"],"alternateVersions":[{"style":"Funny","bio":"alternate funny version"},{"style":"Bold","bio":"alternate bold version"},{"style":"Mysterious","bio":"alternate mysterious version"}]}

currentScore and improvedScore: 1-10
Make the improved bio feel authentic, not generic. Keep the person's personality but make it 10x more attractive.`},{role:'user',content:`Transform this ${platform} bio:\n"${bio}"`}];
const res=await callAIRaw(msgs);
const json=JSON.parse(res.match(/\{[\s\S]*\}/)?.[0]||'{}');
const cs=json.currentScore||4;const is=json.improvedScore||8;
let html='<div class="tool-result">';
html+=`<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px"><div style="padding:14px;background:rgba(239,68,68,.06);border:1px solid rgba(239,68,68,.15);border-radius:12px"><div style="font-size:.7rem;color:#ef4444;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">‚ùå Before (${cs}/10)</div><div style="font-size:.88rem;line-height:1.5;color:var(--text2)">${bio.replace(/</g,'&lt;')}</div></div><div style="padding:14px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:12px"><div style="font-size:.7rem;color:#22c55e;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">‚úÖ After (${is}/10)</div><div style="font-size:.88rem;line-height:1.5;cursor:pointer" onclick="copyText(this.innerText)">${json.improved||''} <span style="font-size:.65rem;color:var(--text3)">tap to copy</span></div></div></div>`;
if(json.problems?.length){html+='<h4 style="color:#ef4444">üîç What Was Wrong</h4>';json.problems.forEach(p=>{html+=`<p style="margin-bottom:3px">‚Ä¢ ${p}</p>`;});}
if(json.changes?.length){html+='<h4 style="margin-top:10px">üîß What Changed</h4>';json.changes.forEach(c=>{html+=`<div style="padding:8px;background:rgba(255,255,255,.02);border-radius:8px;margin-bottom:4px;font-size:.85rem"><strong>${c.what}:</strong> ${c.why}</div>`;});}
if(json.alternateVersions?.length){html+='<h4 style="margin-top:12px">üé® Alternate Versions</h4>';json.alternateVersions.forEach(v=>{html+=`<div style="padding:10px;background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.12);border-radius:10px;margin-bottom:6px;cursor:pointer" onclick="copyText(this.querySelector('.alt-bio-text').innerText)"><div style="font-size:.7rem;font-weight:700;color:var(--accent);margin-bottom:4px">${v.style}</div><div class="alt-bio-text" style="font-size:.88rem">${v.bio}</div><span style="font-size:.65rem;color:var(--text3)">tap to copy</span></div>`;});}
if(json.platformTips?.length){html+=`<h4 style="margin-top:10px">üì± ${platform} Tips</h4>`;json.platformTips.forEach(t=>{html+=`<p style="margin-bottom:3px">‚Ä¢ ${t}</p>`;});}
html+='</div>';
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Transformation failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üìä Transform Bio';
}

// ===== TOOL: FIRST DATE SCRIPT =====
async function runDateScript(){
const interests=document.getElementById('toolInput').value.trim();
const dateType=document.querySelector('#dateTypeChips .tool-chip.active')?.dataset.val||'Coffee Date';
const personality=document.querySelector('#datePersonChips .tool-chip.active')?.dataset.val||'Introverted';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Writing script...';
try{
const msgs=[{role:'system',content:`You are a First Date Script writer. Create a full conversation guide for a ${dateType} where the user is ${personality}. ${interests?'Their date is interested in: '+interests+'.':''}

Format EXACTLY like this:

**üé¨ Opening (First 5 minutes)**
- What to say when you arrive: "[exact line]"
- Icebreaker: "[fun opener question]"
- Body language tip: [specific tip]

**üó£Ô∏è Getting-to-Know Phase (10-20 min)**
- Topic 1: [topic] ‚Üí "[example question]"
- Topic 2: [topic] ‚Üí "[example question]"
- Topic 3: [topic] ‚Üí "[example question]"
- Transition line: "[smooth transition between topics]"

**üòÇ Fun & Flirty Phase (20-30 min)**
- Playful tease: "[example]"
- Compliment to drop: "[specific, genuine compliment]"
- Fun question: "[unique question that sparks chemistry]"
- Callback humor: "[reference something they said earlier]"

**üí´ Going Deeper (30-40 min)**
- Meaningful question: "[deeper question]"
- Vulnerability moment: "[something personal to share]"
- Connection builder: "[activity or topic that bonds]"

**üö™ The Close (Last 5 min)**
- How to suggest a second date: "[exact line]"
- Smooth goodbye: "[parting line]"
- Follow-up text (send 1-2 hours later): "[exact text to send]"

**üö´ Topics to AVOID:**
- [topic 1]
- [topic 2]

**üí° Pro Tips:**
- [tip 1]
- [tip 2]
- [tip 3]

Make all example lines feel NATURAL and match a ${personality} personality. Not scripted or robotic.`},{role:'user',content:`Create a first date script for: ${dateType}, personality: ${personality}${interests?', their interests: '+interests:''}`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Script generation failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üé¨ Generate Script';
}

// ===== TOOL: TRENDING LINES =====
async function runTrendingLines(){
const category=document.querySelector('#trendCatChips .tool-chip.active')?.dataset.val||'Pop Culture';
const style=document.querySelector('#trendStyleChips .tool-chip.active')?.dataset.val||'Smooth';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Finding trends...';
try{
const msgs=[{role:'system',content:`You are a Trending Pickup Lines generator. Create 10 pickup lines/rizz lines inspired by ${category} in a ${style} style. These should reference current trends, popular shows, movies, memes, songs, or cultural moments from 2024-2025.

Format:
1. "[line]" ‚Äî _inspired by [reference]_
2. "[line]" ‚Äî _inspired by [reference]_
...

After the 10 lines, add:

**üî• Best for:** [which situation these work best in]
**üì± Platform tip:** [which dating app/social media these work best on]
**‚ö†Ô∏è Know your audience:** [brief tip on when to use/avoid these]

Make lines CLEVER, not just references. They should work even if the person doesn't get the reference, but be extra impressive if they do.`},{role:'user',content:`Generate 10 trending ${style.toLowerCase()} pickup lines from ${category}`}];
const res=await callAIRaw(msgs);
document.getElementById('toolResult').innerHTML=`<div class="tool-result">${formatToolResult(res)}</div>`;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Couldn't fetch trending lines. Try again!</div>`;}
btn.disabled=false;btn.textContent='üìà Get Trending Lines';
}

// ===== TOOL: MESSAGE DECODER =====
async function runMsgDecoder(){
const text=document.getElementById('toolInput').value.trim();
if(!text){showToast('Paste their message!');return;}
const relationship=document.querySelector('#decoderChips .tool-chip.active')?.dataset.val||'Just met';
const btn=document.getElementById('toolGenBtn');btn.disabled=true;btn.textContent='Decoding...';
try{
const msgs=[{role:'system',content:`You are a Message Decoder ‚Äî an expert at reading between the lines in dating/texting. Analyze the message in the context of "${relationship}" stage. Return ONLY valid JSON:
{"surfaceMeaning":"What the message literally says (1 sentence)","hiddenMeaning":"What they ACTUALLY mean (2-3 sentences, be specific)","interestLevel":7,"interestLabel":"Interested","tone":"playful","emotionalState":"How they're feeling when sending this","intentions":["what they want from this convo"],"subtext":["hidden signal 1","hidden signal 2","hidden signal 3"],"keywords":[{"word":"the specific word/phrase","meaning":"what it signals"}],"bestReplies":["great reply option 1","great reply option 2","great reply option 3"],"worstReplies":["what NOT to say 1","what NOT to say 2"],"verdict":"Overall decode summary in 2-3 sentences"}

interestLevel: 1-10
interestLabel: "Not interested", "Lukewarm", "Curious", "Interested", "Very interested", "Down bad"
tone: one of "cold", "neutral", "friendly", "playful", "flirty", "interested", "distant", "confused", "testing you"
Be brutally honest. Don't sugarcoat if the signs are bad.`},{role:'user',content:`Decode this message (relationship: ${relationship}):\n"${text}"`}];
const res=await callAIRaw(msgs);
const json=JSON.parse(res.match(/\{[\s\S]*\}/)?.[0]||'{}');
const interest=json.interestLevel||5;
const iColor=interest>=7?'#22c55e':interest>=5?'#f59e0b':'#ef4444';
let html='<div class="tool-result">';
html+=`<div style="text-align:center;margin-bottom:14px"><div style="font-size:.7rem;color:var(--text3);text-transform:uppercase;letter-spacing:1px">Interest Level</div><div style="font-size:2rem;font-weight:900;color:${iColor}">${interest}/10</div><div style="font-size:.9rem;font-weight:600;color:${iColor}">${json.interestLabel||'Unknown'}</div><div style="margin-top:6px;display:inline-block;padding:4px 12px;background:rgba(168,85,247,.1);border-radius:99px;font-size:.78rem;color:var(--accent)">Tone: ${json.tone||'neutral'}</div></div>`;
html+=`<h4>üìù What They Said</h4><p style="margin-bottom:10px;color:var(--text2)">${json.surfaceMeaning||''}</p>`;
html+=`<h4>üß† What They Actually Mean</h4><div style="padding:12px;background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.12);border-radius:10px;margin-bottom:12px">${json.hiddenMeaning||''}</div>`;
html+=`<h4>üòä Their Emotional State</h4><p style="margin-bottom:10px">${json.emotionalState||''}</p>`;
if(json.subtext?.length){html+='<h4>üîé Hidden Signals</h4>';json.subtext.forEach(s=>{html+=`<div style="padding:6px 10px;background:rgba(255,255,255,.03);border-radius:8px;margin-bottom:3px;font-size:.85rem">üîπ ${s}</div>`;});}
if(json.keywords?.length){html+='<h4 style="margin-top:10px">üîë Keyword Breakdown</h4>';json.keywords.forEach(k=>{html+=`<div style="padding:6px 10px;background:rgba(99,102,241,.06);border-radius:8px;margin-bottom:3px;font-size:.85rem"><strong>"${k.word}"</strong> ‚Üí ${k.meaning}</div>`;});}
if(json.bestReplies?.length){html+='<h4 style="color:#22c55e;margin-top:10px">‚úÖ Best Replies</h4>';json.bestReplies.forEach((r,i)=>{html+=`<div style="padding:8px 12px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.12);border-radius:10px;margin-bottom:4px;font-size:.88rem;cursor:pointer" onclick="copyText('${r.replace(/'/g,"\\'")}')">${i+1}. "${r}" <span style="font-size:.65rem;color:var(--text3)">tap to copy</span></div>`;});}
if(json.worstReplies?.length){html+='<h4 style="color:#ef4444;margin-top:10px">‚ùå What NOT to Reply</h4>';json.worstReplies.forEach(r=>{html+=`<p style="margin-bottom:3px;color:var(--text2)">‚Ä¢ "${r}"</p>`;});}
html+=`<div style="margin-top:12px;padding:12px;background:rgba(168,85,247,.06);border:1px solid rgba(168,85,247,.15);border-radius:10px"><strong>üéØ Verdict:</strong> ${json.verdict||''}</div>`;
html+='</div>';
document.getElementById('toolResult').innerHTML=html;
playSound('generate');
}catch(e){document.getElementById('toolResult').innerHTML=`<div class="tool-result">Decoding failed. Try again!</div>`;}
btn.disabled=false;btn.textContent='üîç Decode Message';
}

// ===== FORMAT TOOL RESULT =====
function formatToolResult(text){
return text.split('\n').map(line=>{
let l=line.trim();
if(!l)return'<br>';
l=l.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');
l=l.replace(/^(\d+[.)])\s/,'<strong>$1</strong> ');
return`<p style="margin-bottom:4px">${l}</p>`;
}).join('');
}

function copyText(t){navigator.clipboard.writeText(t).then(()=>{showToast('Copied!');playSound('copy');});}

// ===== GEN TABS =====
function initTabs() {
    document.querySelectorAll('.gen-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            // Update Tab UI
            document.querySelectorAll('.gen-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Set Category
            category = tab.dataset.tab;
            
            // Animation for panel switch (optional, simplified for mobile speed)
            playSound('click');
        });
    });

    // Style Chips Selection
    document.querySelectorAll('.style-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.style-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            style = chip.dataset.value;
            playSound('click');
        });
    });

    // Intensity Track Selection
    document.querySelectorAll('.intensity-opt').forEach(opt => {
        opt.addEventListener('click', () => {
            document.querySelectorAll('.intensity-opt').forEach(o => o.classList.remove('active'));
            opt.classList.add('active');
            intensity = opt.dataset.value;
            playSound('click');
        });
    });
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    initTabs();
    document.getElementById('genBtn').addEventListener('click', generateRizz);
    
    // Global Listeners
    document.getElementById('toolOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'toolOverlay') closeTool();
    });
    
    // Stats Update
    renderStatsDashboard(); // Using existing function name
    
    // Daily Challenge Timer
    // setInterval(updateChallengeTimer, 1000); // Assuming this function exists or will be added
    
    // Init other features
    initMainScreenshot();
    checkScheduledCompliments();
    
    // Use existing challenge logic
    if(document.getElementById('challengeGenBtn')) {
        document.getElementById('challengeGenBtn').addEventListener('click', generateChallenge);
    }
});

